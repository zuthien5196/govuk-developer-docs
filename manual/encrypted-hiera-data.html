


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Handle encrypted hieradata - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/encrypted-hiera-data.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Handle encrypted hieradata" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/encrypted-hiera-data.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Handle encrypted hieradata - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/encrypted-hiera-data.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Handle encrypted hieradata</span></a>
    <ul>
      <li>
        <a href="#what-hiera-data-do-we-encrypt"><span>What Hiera data do we encrypt?</span></a>
      </li>
      <li>
        <a href="#why-do-we-encrypt-hiera-data"><span>Why do we encrypt Hiera data?</span></a>
      </li>
      <li>
        <a href="#common-tasks-for-handling-encrypted-hiera-data"><span>Common tasks for handling encrypted Hiera data</span></a>
        <ul>
          <li>
            <a href="#prerequisites"><span>Prerequisites</span></a>
          </li>
          <li>
            <a href="#encrypting-a-hiera-key"><span>Encrypting a Hiera key</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#managing-access-to-encrypted-hiera-data"><span>Managing access to encrypted Hiera data</span></a>
        <ul>
          <li>
            <a href="#what-to-do-when-someone-joins"><span>What to do when someone joins</span></a>
          </li>
          <li>
            <a href="#what-to-do-when-someone-gets-production-access"><span> What to do when someone gets production access</span></a>
          </li>
          <li>
            <a href="#what-to-do-when-someone-leaves"><span>What to do when someone leaves</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#how-to-regenerate-gpg-keys-for-an-environment"><span>How to (re)generate GPG keys for an environment</span></a>
        <ul>
          <li>
            <a href="#configuring-the-puppet-master"><span>Configuring the Puppet Master</span></a>
          </li>
          <li>
            <a href="#uploading-private-gpg-key-to-aws-parameter-store"><span>Uploading private GPG key to AWS parameter store</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#troubleshooting"><span>Troubleshooting</span></a>
        <ul>
          <li>
            <a href="#encryption-fails-when-running-the-rake-task"><span>Encryption fails when running the Rake task</span></a>
          </li>
          <li>
            <a href="#puppet-fails-because-it-can39t-find-a-usable-gpg-key"><span>Puppet fails because it can’t find a usable GPG key</span></a>
          </li>
          <li>
            <a href="#puppet-fails-because-it-can39t-find-gpgme"><span>Puppet fails because it can’t find gpgme</span></a>
          </li>
          <li>
            <a href="#zsh-no-matches-found"><span>zsh: no matches found</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
  <p><a href='/manual.html#deployment'>Deployment</a></p> <h1 id='header'>Handle encrypted hieradata</h1><p><a href="https://docs.puppetlabs.com/hiera/1/">Hiera</a> is a key-value lookup tool
that we use for storing <a href="https://docs.puppetlabs.com/puppet/">Puppet</a>
configuration data. We use <a href="https://github.com/sihil/hiera-eyaml-gpg">Hiera eYAML
GPG</a> to encrypt sensitive
Hiera data.</p>
<p>Hiera eYAML GPG acts as a
<a href="https://docs.puppetlabs.com/hiera/1/custom_backends.html">backend</a> to
Hiera; like a plugin. It enables us to encrypt Hiera data using GPG
keys. In our case, we encrypt the data using the GPG keys of all
security-cleared developers on GOV.UK.</p>
<p>Hiera eYAML GPG only encrypts the Hiera values, rather than the whole file.
It also encrypts each Hiera value individually, so you can see which ones
changed in a git commit.</p>
<h2 id='what-hiera-data-do-we-encrypt'>What Hiera data do we encrypt?</h2><p>Currently, we only encrypt the data in the credentials files found in the
<a href="https://github.com/alphagov/govuk-puppet/tree/master/hieradata">hieradata/</a>
directories of the
<a href="https://github.com/alphagov/govuk-puppet">alphagov/govuk-puppet</a> and
<a href="https://github.com/alphagov/govuk-secrets">alphagov/govuk-secrets</a>
repositories. These files contain secrets such as passwords and private keys.</p>
<h2 id='why-do-we-encrypt-hiera-data'>Why do we encrypt Hiera data?</h2><p>We store secrets and sensitive data in a separate repository,
<a href="https://github.com/alphagov/govuk-secrets">govuk-secrets</a>. This lets
us open the <a href="https://github.com/alphagov/govuk-puppet">govuk-puppet</a>
repository to all developers, while restricting access to the
govuk-secrets repository to a small number of staff.</p>
<p>Deploying puppet copies govuk-secrets over the files in the
<a href="https://github.com/alphagov/govuk-puppet">govuk-puppet</a> repository.</p>
<p>Even though we restrict who can see govuk-secrets, there are still downsides
to storing secrets in plain text:</p>

<ul>
<li>  It&rsquo;s dangerous to leave sensitive data unencrypted on disk. Even if
everyone who has access to the govuk-secrets repository uses
full disk encryption, secrets would be readable if a laptop is infected by
malware, or if someone accidentally commits to a public repository or
copies to an unencrypted disk.</li>
<li>  GitHub notifications send secrets over plain text email if users comment
on specific lines of a pull request that include changes to sensitive data.</li>
<li>  A vulnerability in GitHub or an administrative error when setting
access permissions could expose secrets.</li>
</ul>
<p>By encrypting Hiera data using GPG, we can define who has access to these
secrets (using GPG keys) and we have the extra protection of GPG encryption,
which gives us time to change credentials when secrets are exposed.</p>
<p>There are no plans to merge the govuk-puppet and govuk-secrets repositories.
Having them separate still provides extra protection against accidental exposure.</p>
<h2 id='common-tasks-for-handling-encrypted-hiera-data'>Common tasks for handling encrypted Hiera data</h2><p>Hiera eYAML provides a command-line tool for viewing and editing
encrypted data.</p>
<p>There is a
<a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/Rakefile">Rakefile</a>
in the puppet/ directory of the
<a href="https://github.com/alphagov/govuk-secrets">govuk-secrets</a> repository
which wraps the Hiera eYAML tool and helps to ensure that sensitive data is
only accessible to the intended recipients.</p>
<p>You must use the rake tasks to change encrypted Hiera data.</p>
<h3 id='prerequisites'>Prerequisites</h3>
<ol>
<li><p>Pull the latest changes from the
<a href="https://github.com/alphagov/govuk-secrets">govuk-secrets</a> repository.</p></li>
<li><p>Run <code>bundle</code> to install dependencies.</p></li>
</ol>
<h3 id='encrypting-a-hiera-key'>Encrypting a Hiera key</h3>
<ol>
<li><p>Where <code>integration</code> is the name of the environment whose credentials
you wish to edit, cd into the relevant directory:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cd puppet_aws
</code></pre></div><p>and run:</p>
<div class="highlight"><pre class="highlight plaintext"><code>bundle exec rake eyaml:edit[integration]
</code></pre></div><p>It will ask you for your GPG passphrase. If you get an
error, please see the troubleshooting section below.</p>
<p>The above command will open a text editor (as determined by the
<code>$EDITOR</code> environment variable) showing the undecrypted Hiera data in
YAML format.</p>
<p>An unencrypted Hiera key and value looks like:</p>
<div class="highlight"><pre class="highlight plaintext"><code>password: 'thisisasecret'
</code></pre></div></li>
<li><p>To encrypt the Hiera value, enclose it in square brackets prefixed
with the string DEC::GPG and suffixed with a trailing exclamation
mark (!).</p>
<p>The above example would look as follows:</p>
<div class="highlight"><pre class="highlight plaintext"><code>password: DEC::GPG[thisisasecret]!
</code></pre></div><p>Do not enclose it in single or double quotes as this will get
interpreted as part of the secret.</p>
<p>Once you have finished, save the file and quit the editor.
Hiera eYAML will encrypt your changes. If you get an error, please see the
troubleshooting section below.</p>

<blockquote>
<p><strong>Note</strong></p>
<p>When editing a Hiera key that has been encrypted before, you will
notice a number in parentheses after the word GPG; for
example: DEC::GPG(1). You should not make any changes to the number, as
Hiera eYAML GPG uses this to identify existing encrypted data.</p>
</blockquote></li>
<li><p>Check that the value is really encrypted! If you make a typo in your markup,
Hiera eYAML doesn&rsquo;t always treat it as an error.</p>
<div class="highlight"><pre class="highlight plaintext"><code>GIT_PAGER='less -S' git diff
</code></pre></div></li>
</ol>
<h2 id='managing-access-to-encrypted-hiera-data'>Managing access to encrypted Hiera data</h2><p>The list of people that have access to encrypted Hiera data in stored in a
recipient file specific to each environment (<code>.rcp</code> extension).</p>
<p>The production and integration files are stored in the govuk-secrets repo for
<a href="https://github.com/alphagov/govuk-secrets/tree/master/puppet/gpg_recipients">Carrenza</a>
and <a href="https://github.com/alphagov/govuk-secrets/tree/master/puppet_aws/gpg_recipients">AWS</a>.
There is no separate staging file; the production file is used for both
staging and production.</p>
<p>Each line in a recipient file corresponds to a <a href="http://en.wikipedia.org/wiki/Public_key_fingerprint">GPG fingerprint</a> and
usually is identified by a comment after the hash (#) symbol denoting
its owner. Each GPG key (and owner of that key) listed in the recipient
file is able to decrypt data belonging to the environment that the
recipient file pertains to.</p>
<h3 id='what-to-do-when-someone-joins'>What to do when someone joins</h3>
<ol>
<li> Ask the joiner to <a href="/manual/create-a-gpg-key.html">create a GPG key</a> and upload it
to a public key server (such as <a href="https://pgp.mit.edu/">https://pgp.mit.edu/</a>).</li>
<li> Get the fingerprint of the new GPG key by running <code>gpg --fingerprint</code>.</li>
<li> Add the joiners&rsquo;s GPG fingerprint to each of the recipient files
for Carrenza
<a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/integration_hiera_gpg.rcp">integration</a>,
AWS <a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet_aws/gpg_recipients/integration_hiera_gpg.rcp">integration</a></li>
<li> Recrypt the hieradata by running <code>re-encrypt-all.sh &lt;message&gt;</code> where <code>&lt;message&gt;</code>
is something like &ldquo;Adding new key for Jane Smith&rdquo;.</li>
<li> Commit your changes and raise a pull request for review.</li>
<li> Check that the joiner has uploaded their GPG key.
If their key isn&rsquo;t on a public keyserver it interupts other people&rsquo;s workflow so please make sure it has been uploaded.</li>
<li> Take care when rebasing changes to master that have been merged since you
started your PR. The encrypted hieradata files are effectively binary data
that git&rsquo;s text diff may not correctly merge. You will likely have to
reset your recrypted versions and start again from the versions on master.</li>
</ol>
<h3 id='what-to-do-when-someone-gets-production-access'> What to do when someone gets production access</h3><p>Follow the steps above but add their GPG fingerprint to the production recipient files for Carrenza <a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/production_hiera_gpg.rcp">production</a> and AWS <a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet_aws/gpg_recipients/production_hiera_gpg.rcp">production</a>.</p>
<p>Note there are no staging recipient files - access to staging secrets is controlled by the production recipient files.</p>
<h3 id='what-to-do-when-someone-leaves'>What to do when someone leaves</h3><p>Remove leavers from all recipient files, so that they can no longer change
credentials.</p>

<ol>
<li> Delete the leaver&rsquo;s GPG fingerprint from each of the recipient files
for Carrenza
<a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/integration_hiera_gpg.rcp">integration</a>
and <a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/production_hiera_gpg.rcp">production</a>,
AWS <a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet_aws/gpg_recipients/integration_hiera_gpg.rcp">integration</a>
and <a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet_aws/gpg_recipients/production_hiera_gpg.rcp">production</a>.
There are no staging recipient files since these are the same as the
production recipient files.</li>
<li> Commit your changes and raise a pull request for review.</li>
</ol>

<blockquote>
<p><strong>WARNING</strong></p>
<p>Removing a GPG key from the recipient key and re-encrypting the
credentials files does <strong>not</strong> mean that the leaver is no longer able
to read the secrets it currently contains.</p>
<p>Anyone who has previously had access to a credentials file may have
retained a copy of the data. They are still able to decrypt the
current copy of the credentials file and have made unencrypted copies.</p>
<p>We must assume that, until the stored credentials are rotated and the
credentials file is re-encrypted any secrets contained in the
credentials file can still be read by anyone with a GPG key previously
listed in the recipient list.</p>
</blockquote>
<h2 id='how-to-regenerate-gpg-keys-for-an-environment'>How to (re)generate GPG keys for an environment</h2><p>If a new environment is added or the Puppet GPG key for an existing environment
expires or is compromised, a new GPG key must be generated. This key allows
Puppet to read encrypted Hiera data.</p>
<p>To ensure consistency, new GPG keys are generated using a template
(<a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_templates/production_hiera_gpg_template.txt">example</a>).</p>
<p>To generate a new key:
1.  Generate a random passphrase using a secure method (such as openssl with
    command <code>openssl rand -base64 65 | tr -d &#39;\n&#39; | awk &#39;{ print $0 }&#39;</code> to
    generate a 65 characters random string).</p>

<ol>
<li><p>Generate the GPG key pair (this assumes you are using GPG 2.x):</p>

<ol>
<li> Git clone the <a href="https://github.com/alphagov/govuk-secrets">govuk-secret</a></li>
<li> Create a new directory where the GPG key pair will be created:
e.g. <code>mkdir ~/new_hiera_gpg &amp;&amp; cd ~/new_hiera_gpg</code></li>
<li><p>Create the GPG key ring (<code>pubring.kbx</code>) based on the appropriate template
(this will depend on the environment that you want to create the GPG key
for) in <a href="https://github.com/alphagov/govuk-secrets/tree/master/puppet/gpg_templates">govuk-secrets</a>:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--homedir</span> <span class="nv">$PWD</span> <span class="nt">--verbose</span> <span class="nt">--batch</span> <span class="nt">--gen-key</span> &lt;path_to_selected_template&gt;
</code></pre></div><p>where <code>&lt;path_to_selected_template&gt;</code> is the file path of the template you
want to use. You will be prompted for the passphrase</p></li>
<li><p>Extract the public key (<code>pubring.gpg</code>) of the GPG key pair by running:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--homedir</span> <span class="nv">$PWD</span> <span class="nt">--keyring</span> ./pubring.kbx <span class="nt">--export</span> <span class="o">&gt;</span> ./pubring.gpg
</code></pre></div><p>You should store this key in the appropriate location in govuk-secrets:
e.g. for integration <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg/integration">here</a>
and for production <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg/production">here</a></p></li>
<li><p>Extract the passphrase protected private key (<code>secring.gpg</code>) of the GPG
key pair by running (you will have to supply the passphrase):</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--homedir</span> <span class="nv">$PWD</span> <span class="nt">--keyring</span> ./pubring.kbx <span class="nt">--export-secret-key</span> <span class="o">&gt;</span> ./secring.gpg
</code></pre></div><p>You should store this key in the appropriate location in govuk-secrets:
e.g. for integration <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg/integration">here</a>
and for production <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg/production">here</a></p></li>
<li><p>You can obtain the fingerprint of the GPG key pair by running:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">-n</span> <span class="nt">-q</span> <span class="nt">--import</span> <span class="nt">--import-options</span> import-show pubring.gpg
</code></pre></div><p>and noting the 41 character string in the output.</p></li>
<li><p>Send the key to the ubuntu key server by running:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--homedir</span> <span class="nv">$PWD</span> <span class="nt">--keyserver</span> keyserver.ubuntu.com <span class="nt">--send-key</span> &lt;fingerprint&gt;
</code></pre></div><p>where <code>&lt;fingerprint&gt;</code> was obtained above.</p></li>
</ol></li>
<li><p>Add the passphrase you used when creating the new GPG key to the 2nd line
password store by running inside the <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass">pass</a> directory of the govuk-secrets:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">PASSWORD_STORE_GPG_OPTS</span><span class="o">=</span><span class="s2">"--trust-model always"</span> ./edit.sh 2ndline hiera-eyaml-gpg/&lt;environment_passphrase_key&gt;
</code></pre></div><p>where the <code>&lt;environment_passphrase_key&gt;</code> can be: <code>production-gpg-key-passphrase</code>
or <code>integration-gpg-key-passphrase</code> depending on which environment you are
modifying.
Note that <code>PASSWORD_STORE_GPG_OPTS</code> is required here or otherwise GPG will
refuse to encrypt the data since the new GPG key isn&rsquo;t trusted by default.</p>
<p>If you get any error message, you should read the stored secret passphrase
again to ensure that the correct value has been stored.</p></li>
<li><p>Change the relevant files to remove the fingerprint of the old
key and add the new fingerprint (as obtained above). If you changed:</p>

<ol>
<li> integration:

<ul>
<li><a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/integration_hiera_gpg.rcp">carrenza puppet recipients file for integration</a></li>
<li><a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/integration_hiera_gpg.rcp">aws puppet recipients file for integration</a></li>
<li><a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet_common/gpg_recipients.rb">common puppet ruby recipient file</a></li>
</ul></li>
<li> production:

<ul>
<li><a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/production_hiera_gpg.rcp">carrenza puppet recipients file for production</a></li>
<li><a href="https://github.com/alphagov/govuk-secrets/blob/master/puppet/gpg_recipients/production_hiera_gpg.rcp">aws puppet recipients file for production</a></li>
</ul></li>
</ol></li>
<li><p>Add and commit locally your changes to govuk-secrets. You can then use
the <a href="https://github.com/alphagov/govuk-secrets/blob/master/re-encrypt-all.sh">re-encrypt-all.sh</a>
to re-encrypt all the relevant parts of govuk-secrets.</p></li>
<li><p>Open a pull request with all the changes so far and get it approved and
merged.</p></li>
<li><p>Next, you need, as detailed in subsequent sections, to:</p>

<ol>
<li> Configure the Puppet Master in the relevant environment</li>
<li> Upload the non-passphrase protected private GPG key to AWS parameter store</li>
</ol></li>
</ol>

<blockquote>
<p><strong>WARNING</strong></p>
<p>If you&rsquo;re generating a new key because the old one has been compromised, or
if it has not yet expired, you should revoke the old key to prevent it being
used.</p>
</blockquote>
<h3 id='configuring-the-puppet-master'>Configuring the Puppet Master</h3><p>The GPG key <code>secring.gpg</code>, stored in the <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg">2ndline password
store</a> in the
<a href="https://github.com/alphagov/govuk-secrets">govuk-secrets</a> repository,
must be installed on the Puppet Master so that encrypted Hiera data is available
to Puppet:</p>

<ol>
<li><p>Create a new directory to do the GPG operations:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">mkdir</span> ~/unprotected_gpg <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/unprotected_gpg
</code></pre></div></li>
<li><p>Copy in the new directory the private GPG key <code>secring.gpg</code> of the relevant
environment from the <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg">directory</a>
in govuk-secrets.</p></li>
<li><p>In the new directory, get the fingerprint of the GPG key by running:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">-n</span> <span class="nt">-q</span> <span class="nt">--import</span> <span class="nt">--import-options</span> import-show secring.gpg
</code></pre></div><p>and noting the 41 character string in the output.</p></li>
<li><p>Import the private GPG key:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--homedir</span> <span class="nv">$PWD</span> <span class="nt">--import</span> secring.gpg
</code></pre></div></li>
<li><p>Extract the non-passphrase protected private key (<code>secring_unprotected.gpg</code>)
by running: <code>gpg --homedir $PWD --edit-key &lt;finderprint&gt;</code>
where <code>&lt;fingerprint&gt;</code> was obtained in the previous step. You will then
enter the GPG prompt where you should type <code>passwd</code>. You will then be
asked to provide the current passphrase of the private key and afterwards,
you will be asked to provide a new passphrase which should be
empty/nothing. You may get a prompt asking to confirm that you want to
unprotect the key and you should confirm yes. You can quit the GPG prompt
by typing <code>quit</code></p>
<p>You can extract the unprotected key by exporting it:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--homedir</span> <span class="nv">$PWD</span> <span class="nt">--export-secret-key</span> &lt;fingerprint&gt; <span class="o">&gt;</span> secring_unprotected.gpg
</code></pre></div><p>where <code>&lt;fingerprint&gt;</code> is the fingerprint obtained above.</p></li>
<li><p>SSH to the Puppet Master (for example,
<code>puppetmaster-1.management.staging</code>).</p></li>
<li><p>Change to the root user (<code>sudo su -</code>).</p></li>
<li><p>Go to <code>/etc/puppet/gpg</code> directory.</p></li>
<li><p>Create a new folder (for example, <code>old</code>) and move all files currently in the
<code>gpg</code> folder into there as a backup.</p></li>
<li><p>Copy the following files to the Puppet Master using from your local machine:</p>

<ol>
<li> <code>secring_unprotected.gpg</code> as <code>/etc/puppet/gpg/secring.gpg</code> on puppetmaster</li>
<li> <code>pubring.gpg</code> (obtained from the appropriate environment/directory in <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass/2ndline/hiera-eyaml-gpg">here</a>) as <code>/etc/puppet/gpg/pubring.gpg</code> on puppetmaster.</li>
</ol></li>
<li><p>Make sure the new files have the correct permissions:
 <code>sudo chown -R puppet:puppet /etc/puppet/gpg</code> and
 <code>sudo chmod -R 0700 /etc/puppet/gpg</code>.</p></li>
<li><p>Re-deploy Puppet to pick up the changes.</p></li>
</ol>

<blockquote>
<p><strong>WARNING</strong></p>
<p>Make sure <strong>not</strong> to copy the production GPG key to the integration environment.</p>
<p><strong>Note</strong></p>
<p>In the time between adding the new keys to the Puppet Master, deploying
puppet, and it running on all machines in the relevant environment, you
will see alerts in Icinga about puppet not being able to read config files.
These alerts will go away as each machine runs puppet.</p>
</blockquote>
<h3 id='uploading-private-gpg-key-to-aws-parameter-store'>Uploading private GPG key to AWS parameter store</h3><p>The non-passphrase protected private GPG key must be uploaded to the AWS
parameter store so that if puppet is re-provisioned in AWS, the new instance of
puppet will automatically get the private GPG key to decrypt the secret hiera.</p>
<p>This can be done by:
1.  Follow the steps in section <code>Configuring the Puppet Master</code> to get the
    non-passphrase protected private GPG key.</p>

<ol>
<li><p>Split the non-passphrase protected GPG key into 3 parts due
to the issue that the AWS parameter store has a size limit per item.
This can be done by running:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">base64 </span>secring_unprotected.gpg <span class="o">&gt;</span> secring_unprotected.gpg.base64
<span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'n'</span> &lt; secring_unprotected.gpg.base64 <span class="o">&gt;</span> secring_unprotected.gpg.base64.trimmed
<span class="nb">split</span> <span class="nt">-b</span> 4096 secring_unprotected.gpg.base64.trimmed secring_unprotected_part_
</code></pre></div><p>You will obtained a number of files with name starting with
<code>secring_unprotected_part_</code>.</p></li>
<li><p>Upload the <code>secring_unprotected_part_</code> parts to AWS parameter store:</p>

<ol>
<li> Login to the AWS web console of the environment to be modified</li>
<li> Browse to the AWS Systems Manager and then to the Parameter Store (
link is usually at the bottom of the left column of the Systems Manager)</li>
<li> There will be 3 keys with prefix: <code>govuk_base64_gpg_</code> which you should
update with the content of the files <code>secring_unprotected_part_</code></li>
</ol></li>
</ol>
<h2 id='troubleshooting'>Troubleshooting</h2><h3 id='encryption-fails-when-running-the-rake-task'>Encryption fails when running the Rake task</h3><p>If the rake task to edit the encrypted credentials fails, with errors
such as:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ bundle exec rake eyaml:edit[integration]
[gpg] !!! Warning: General exception decrypting GPG file
[hiera-eyaml-core] !!! Bad file descriptor
</code></pre></div><p>Check that you&rsquo;re using GPG version 2 or above. Hiera eYAML GPG appears
to fail when using GPG version 1 with lots of credentials.</p>
<p>If you see this error:</p>
<div class="highlight"><pre class="highlight plaintext"><code>General error
</code></pre></div><p>Try pulling <code>master</code> again - there&rsquo;s a good chance someone has made a
change since you made your changes. Otherwise, check if any of the GPG
keys in the recipients list have expired.</p>
<p>If you see this error:</p>
<div class="highlight"><pre class="highlight plaintext"><code>[hiera-eyaml-core] !!! Bad passphrase
</code></pre></div><p>Check that your GPG configuration is sane. Try encrypting and decrypting
some dummy text using the <code>gpg</code> command:</p>
<div class="highlight"><pre class="highlight plaintext"><code>echo 'foo' | gpg --armor --encrypt --recipient matt.bostock@digital.cabinet-office.gov.uk | gpg --decrypt
</code></pre></div><p>The <code>gpg</code> command above might give a more useful error message than the
gpgme library, which Hiera eYAML GPG uses.</p>
<p>If you see this error:</p>
<div class="highlight"><pre class="highlight plaintext"><code>[hiera-eyaml-core] !!! Decryption failed
</code></pre></div><p>Make sure that another PR re-encrypting the credentials was not merged
before your one. If this is the case, the credentials will need to be
re-encrypted again, making sure that your GPG key fingerprint is in the
relevant recipient files.</p>
<p>If you see this error:</p>
<div class="highlight"><pre class="highlight plaintext"><code>[hiera-eyaml-core] No key found on keyring for &lt;fingerprint&gt;
</code></pre></div><p>This means that you don&rsquo;t have one of the recipient&rsquo;s key on your keyring.
You can download one or more keys with the following command:</p>
<div class="highlight"><pre class="highlight shell"><code>gpg <span class="nt">--keyserver</span> keyserver.ubuntu.com <span class="nt">--recv-keys</span> &lt;fingerprint&gt;
</code></pre></div><p>Alternatively, you can run the <code>govuk-secrets/pass/trust_all.sh</code> script. This
will fetch all recipient keys from the keyserver.
<a href="https://github.com/alphagov/govuk-secrets/tree/master/pass#trust-user-public-keys">More information can be found in the govuk-secrets README</a>.</p>
<h3 id='puppet-fails-because-it-can39t-find-a-usable-gpg-key'>Puppet fails because it can&rsquo;t find a usable GPG key</h3><p>When Puppet runs, you may see the following error:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Hiera eYAML GPG encryption backend is not working; check that Puppet has a valid GPG key
</code></pre></div><p>This error can occur for the following reasons:</p>

<ul>
<li>  Puppet cannot find a GPG keyring in <code>/etc/puppet/gpg</code>. This
should only occur in development or test VMs <strong>or</strong> on the
Puppet Master. Check that you have copied the GPG keys from the
2ndline pass store to <code>/etc/puppet/gpg</code> - see <a href="#configuring-the-puppet-master">configuring the Puppet Master</a>.
Servers running <code>puppet-agent</code> do not require a GPG key as they
rely on the Puppet Master to provide and, when necessary, decrypt
Hiera data.</li>
<li>  The GPG key has expired; it should be replaced with a new key -
see <a href="#how-to-regenerate-gpg-keys-for-an-environment">how to (re)generate GPG keys for an environment</a>.</li>
<li><p>The Hiera YAML files contain encrypted data for which the GPG keys
in <code>/etc/puppet/gpg</code> is not listed as a recipient. Check the GPG
recipient files and compare the fingerprint there to the fingerprint
of the GPG keyring in <code>/etc/puppet/gpg</code>. You can find the fingerprint
by executing the following command on the server:</p>
<div class="highlight"><pre class="highlight plaintext"><code>GNUPGHOME=/etc/puppet/gpg gpg --fingerprint
</code></pre></div></li>
</ul>
<h3 id='puppet-fails-because-it-can39t-find-gpgme'>Puppet fails because it can&rsquo;t find gpgme</h3><p>You can add the <code>$LOAD_PATH</code> to <code>/usr/bin/puppet</code> as shown
in <a href="https://github.com/alphagov/govuk-puppet/commit/b7743452875b1dd83fda982e28ae8e776bc3a8b8">this commit</a>.</p>
<h3 id='zsh-no-matches-found'>zsh: no matches found</h3><p>If you encounter an error similar to</p>
<div class="highlight"><pre class="highlight plaintext"><code>zsh: no matches found: eyaml:edit[integration]
</code></pre></div><p>Try either enclosing the rake command in single quotes or
set the
<a href="http://zsh.sourceforge.net/Doc/Release/Options.html#index-NOGLOB">noglob</a>
option.</p>
<div class="highlight"><pre class="highlight plaintext"><code>noglob bundle exec rake eyaml:edit[integration]
</code></pre></div>

  <div class='related-content'>

    <h3>More in the Deployment section</h3>

    <div class='govuk-grid-row'>
        <div class='govuk-grid-column-one-half'>
          <h4>Learn</h4>

          <ul class="govuk-list">
            <li><a href="/manual/development-pipeline.html">The development and deployment pipeline</a></li>
          </ul>
        </div>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/deploy-puppet.html">Deploy Puppet</a></li>
            <li><a href="/manual/deploy-static.html">Deploy Static</a></li>
            <li><a href="/manual/deploying-terraform.html">Deploy Terraform</a></li>
            <li><a href="/manual/github-unavailable.html">Deploy when GitHub is unavailable</a></li>
            <li><a href="/manual/deployment-dashboards.html">Deployment dashboards</a></li>
            <li><a href="/manual/fall-back-to-aws-cloudfront.html">Fall back to AWS CloudFront</a></li>
            <li><a href="/manual/fall-back-to-mirror.html">Fall back to the static mirrors</a></li>
            <li><a href="/manual/publish-special-routes.html">Publish special routes</a></li>
            <li><a href="/manual/restart-application.html">Restart an application</a></li>
            <li><a href="/manual/running-rake-tasks.html">Run a rake task</a></li>
            <li><a href="/manual/review-apps.html">Set up Heroku review apps for pull requests</a></li>
            <li><a href="/manual/howto-switch-off-app.html">Switch an app off temporarily</a></li>
          </ul>
        </div>

    </div>
</div>


              <div data-module='page-expiry' data-last-reviewed-on="2020-10-28">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 28 January 2020.

        It needs to be reviewed again on 28 October 2020
        by the page owner <a href="">#govuk-developers</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 28 October 2020
       by the page owner <a href="">#govuk-developers</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/encrypted-hiera-data.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Handle%20encrypted%20hieradata'&amp;body=Problem%20with%20'Handle%20encrypted%20hieradata'%20(https://docs.publishing.service.gov.uk/manual/encrypted-hiera-data.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
