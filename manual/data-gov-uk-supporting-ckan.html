


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Support tasks for CKAN - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/data-gov-uk-supporting-ckan.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Support tasks for CKAN" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/data-gov-uk-supporting-ckan.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Support tasks for CKAN - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/data-gov-uk-supporting-ckan.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Support tasks for CKAN</span></a>
    <ul>
      <li>
        <a href="#environments"><span>Environments</span></a>
      </li>
      <li>
        <a href="#managing-ckan"><span>Managing CKAN</span></a>
        <ul>
          <li>
            <a href="#initialising-the-database"><span>Initialising the database</span></a>
          </li>
          <li>
            <a href="#accessing-the-database"><span>Accessing the database</span></a>
          </li>
          <li>
            <a href="#accessing-the-ckan-api"><span>Accessing the CKAN API</span></a>
          </li>
          <li>
            <a href="#creating-a-system-administrator-account"><span>Creating a system administrator account</span></a>
          </li>
          <li>
            <a href="#removing-a-system-administrator-account"><span>Removing a system administrator account</span></a>
          </li>
          <li>
            <a href="#managing-users"><span>Managing users</span></a>
          </li>
          <li>
            <a href="#managing-publishers"><span>Managing publishers</span></a>
          </li>
          <li>
            <a href="#managing-datasets"><span>Managing datasets</span></a>
          </li>
          <li>
            <a href="#rebuilding-the-search-index"><span>Rebuilding the search index</span></a>
          </li>
          <li>
            <a href="#csw-endpoint"><span>csw endpoint</span></a>
          </li>
          <li>
            <a href="#harvesting"><span>Harvesting</span></a>
          </li>
          <li>
            <a href="#ckan-publisher-on-staging-environment-responds-with-nginx-504-timeout"><span>CKAN publisher on Staging environment responds with Nginx 504 timeout:</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
  <p><a href='/manual.html#data-gov-uk'>data.gov.uk</a></p> <h1 id='header'>Support tasks for CKAN</h1><p><a href="https://ckan.publishing.service.gov.uk">CKAN</a> is the publishing application for data.gov.uk.  <a href="/apps/ckanext-datagovuk.html">ckanext-datagovuk</a> is the primary <a href="https://ckan.org">CKAN</a> extension for data.gov.uk.</p>
<h2 id='environments'>Environments</h2><p>There are three environments for <a href="https://ckan.org">CKAN</a>:</p>

<ul>
<li><a href="https://ckan.publishing.service.gov.uk">Production</a></li>
<li><a href="https://ckan.staging.publishing.service.gov.uk">Staging</a></li>
<li><a href="https://ckan.integration.publishing.service.gov.uk">Integration</a></li>
</ul>
<p>You can SSH onto these machines in <a href="/manual/howto-ssh-to-machines.html">same way as all other GOV.UK AWS applications</a>.  The machine node class is <code>ckan</code>.</p>
<h2 id='managing-ckan'>Managing CKAN</h2><p>First check to see if it is possible to complete the task through the <a href="https://ckan.publishing.service.gov.uk">web interface</a>
(credentials are available in the <code>govuk-secrets</code> password store, under <code>datagovuk/ckan</code>).</p>
<p>For commands not available via the user interface you must connect to the server to perform these
tasks.  Most of the commands to interact with <a href="https://ckan.org">CKAN</a> use a tool called <code>paster</code>.  Many of these
commands take a path to the config file with the <code>-c</code> option, which is located at <code>/var/ckan/ckan.ini</code>
in our deployments.</p>
<p>On GOV.UK servers <code>paster</code> should be run with:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cd /var/apps/ckan
sudo -u deploy govuk_setenv ckan venv/bin/paster [COMMAND] -c /var/ckan/ckan.ini
</code></pre></div><h3 id='initialising-the-database'>Initialising the database</h3><p>There may be times when you need to start with an empty database (e.g. on integration).
The following commands will create the relevant schema for core CKAN and the harvesting
extension on integration.</p>
<div class="highlight"><pre class="highlight plaintext"><code>. /var/apps/ckan/venv/bin/activate
paster --plugin=ckan db init -c /var/ckan/ckan.ini
paster --plugin=ckanext-harvest harvester initdb -c /var/ckan/ckan.ini
</code></pre></div><h3 id='accessing-the-database'>Accessing the database</h3><p>In order to access the CKAN database to run queries on the <code>db_admin</code> machine:</p>
<p><code>psql -U ckan -h postgresql-primary -p 5432 ckan_production</code></p>
<p>The password can be extracted from the configuration file on the <code>ckan</code> machine for the environment you are targeting:</p>
<p><code>more /var/ckan/ckan.ini | grep sqlalchemy</code></p>
<h3 id='accessing-the-ckan-api'>Accessing the CKAN API</h3><p>There are times when it can be useful to access the <a href="https://docs.ckan.org/en/2.8/api/">CKAN API</a> when debugging or resolving issues. Note that the responses will be different depending on your access permissions.</p>
<p>Queries can use the package ID or name (the slug) e.g.</p>
<div class="highlight"><pre class="highlight plaintext"><code>https://data.gov.uk/api/3/action/package_search?q=id:93a39f01-7bba-430f-aa35-c30bf2d88b2f
returns the same as
https://data.gov.uk/api/3/action/package_search?q=name:north-lincolnshire-brown-field-register

</code></pre></div><p>Here are some more complex examples of using the API, as well as some where the documentation is more sparse:</p>
<div class="highlight"><pre class="highlight plaintext"><code># Retrieve full details about a package (dataset)
https://data.gov.uk/api/3/action/package_search?q=name:north-lincolnshire-brown-field-register

# Find all packages created during a specific timeframe
https://data.gov.uk/api/3/action/package_search?q=metadata_created:[2017-06-01T00:00:00Z%20TO%202017-06-30T00:00:00Z]

# Find all packages modified during a specific timeframe
https://data.gov.uk/api/3/action/package_search?q=metadata_modified:[2017-06-01T00:00:00Z%20TO%202017-06-30T00:00:00Z]

# Count all packages and list a sample
 https://ckan.publishing.service.gov.uk/api/search/dataset?fl=id,dataset_type,name,title,extras_guid,extras_harvest_source_title,extras_harvest_object_id&amp;q=state:active%20and%20dataset_type:dataset&amp;limit=20

# Count harvested packages and list a sample
 https://ckan.publishing.service.gov.uk/api/search/dataset?fl=id,state,dataset_type,name,title,extras_guid,extras_harvest_source_title,extras_harvest_object_id&amp;q=state:active%20and%20extras_harvest_object_id:[%22%22%20TO%20*]%20and%20dataset_type:dataset&amp;limit=20

# Count manually published packages and list a sample
 https://ckan.publishing.service.gov.uk/api/search/dataset?fl=id,dataset_type,name,title,extras_guid,extras_harvest_source_title,extras_harvest_object_id&amp;q=state:active%20and%20-extras_harvest_object_id:*%20and%20dataset_type:dataset&amp;limit=20

# Count packages harvested in last 7 days and list a sample https://ckan.publishing.service.gov.uk/api/search/dataset?fl=id,state,dataset_type,name,title,extras_guid,extras_harvest_source_title,extras_harvest_object_id&amp;q=state:active%20and%20extras_harvest_object_id:[%22%22%20TO%20*]%20and%20dataset_type:dataset%20and%20metadata_modified:[NOW-7DAY/DAY%20TO%20NOW]&amp;limit=20

# Count packages manually published in last 7 days and list a sample https://ckan.publishing.service.gov.uk/api/search/dataset?fl=id,dataset_type,name,title,extras_guid,extras_harvest_source_title,extras_harvest_object_id&amp;q=state:active%20and%20-extras_harvest_object_id:*%20and%20dataset_type:dataset%20and%20metadata_modified:[NOW-7DAY/DAY%20TO%20NOW]&amp;limit=20

# Count packages from Daily harvest sources and list a sample
https://ckan.publishing.service.gov.uk/api/search/dataset?fl=id,metadata_modified,dataset_type,name,title,extras_guid,extras_harvest_source_title,extras_harvest_object_id,extras_frequency-of-update&amp;q=state:active%20and%20extras_harvest_object_id:%5B%22%22%20TO%20*%5D%20and%20frequency-of-update:daily%20and%20dataset_type:dataset&amp;limit=20

# List all publishers
https://data.gov.uk/api/3/action/organization_list

# View a publisher record
https://data.gov.uk/api/3/action/organization_show?id=government_digital_service

# View a user (e.g. to get CKAN API key for a publishing user)
https://data.gov.uk/api/3/action/user_show?id=user_d484581
</code></pre></div><h3 id='creating-a-system-administrator-account'>Creating a system administrator account</h3><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan sysadmin add USERNAME email=EMAIL_ADDRESS -c /var/ckan/ckan.ini
</code></pre></div><p>You will be prompted twice for a password.</p>
<h3 id='removing-a-system-administrator-account'>Removing a system administrator account</h3><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan sysadmin remove USERNAME -c /var/ckan/ckan.ini
</code></pre></div><h3 id='managing-users'>Managing users</h3><h4 id='listing-users'>Listing users</h4><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan user list -c /var/ckan/ckan.ini
</code></pre></div><h4 id='viewing-a-user'>Viewing a user</h4><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan user USERNAME -c /var/ckan/ckan.ini
</code></pre></div><h4 id='adding-a-user'>Adding a user</h4><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan user add USERNAME email=EMAIL_ADDRESS -c /var/ckan/ckan.ini
</code></pre></div><h4 id='removing-a-user'>Removing a user</h4><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan user remove USERNAME -c /var/ckan/ckan.ini
</code></pre></div><h4 id='changing-a-user39s-password'>Changing a user&rsquo;s password</h4><div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan user setpass USERNAME -c /var/ckan/ckan.ini
</code></pre></div><h3 id='managing-publishers'>Managing publishers</h3><h4 id='change-a-publisher39s-name'>Change a publisher&rsquo;s name</h4><p>Change the name in the publisher page then reindex that publisher:</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan search-index rebuild-publisher [PUBLISHER] -c /var/ckan/ckan.ini
</code></pre></div><h3 id='managing-datasets'>Managing datasets</h3><h4 id='deleting-a-dataset'>Deleting a dataset</h4><p><a href="https://ckan.org">CKAN</a> has two types of deletions, the default soft-delete, and a purge.  The soft delete gives the option of
undeleting a dataset but the purge will remove all trace of it from the system.</p>
<p>Where the following commands mention DATASET_NAME, this should either be the slug for the dataset, or the
UUID.</p>
<p>Deleting a dataset:</p>

<ol>
<li>Find the dataset in the CKAN UI</li>
<li>Click on the &lsquo;Manage&rsquo; button, then the &lsquo;Delete&rsquo; button at the bottom of the page</li>
</ol>

<blockquote>
<p>The &lsquo;Delete&rsquo; button is currently not available for draft datasets. In order to soft-delete a draft dataset, follow the above steps, but manually change &lsquo;edit&rsquo; to &lsquo;delete&rsquo; on the &lsquo;Manage&rsquo; page for the dataset.</p>
</blockquote>
<p>Purging a dataset:</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan dataset purge DATASET_NAME -c /var/ckan/ckan.ini
</code></pre></div><p>There may be times when a large number of datasets must be deleted.  This can be done remotely from your
machine using the CKAN API.  Your API key is required, which can be obtained from your user profile on
the web interface.  Put a list of dataset slugs or GUIDs in a text file, with one dataset per line, then
run the following.</p>
<div class="highlight"><pre class="highlight plaintext"><code>while read p; do curl --request POST --data "{\"id\": \"$p\"}" --header "Authorization: &lt;your_api_key&gt;" https://data.gov.uk/api/3/action/package_delete; done &lt; list_of_ids.txt
</code></pre></div><p>After deleting or purging a dataset, it will take up to 10 minutes to update on Find, due to the sync process.</p>
<h4 id='register-a-brownfield-dataset'>Register a brownfield dataset</h4><p>See the <a href="https://docs.google.com/document/d/1SxzN9Ihat75TXo-fMwFqW_qBS-bPKHRs-a-tAO-qA1c/edit?usp=sharing">supporting manual</a>.</p>
<h3 id='rebuilding-the-search-index'>Rebuilding the search index</h3><p><a href="https://ckan.org">CKAN</a> uses Solr for its search index, and occasionally it may be necessary to interact with it
to refresh the index, or rebuild it from scratch.</p>
<p>Refresh the entire search index (this adds/removes datasets, but does not clear the index first):</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan search-index rebuild -r -c /var/ckan/ckan.ini
</code></pre></div><p>Rebuild the entire search index (this deletes the index before re-indexing begins):</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan search-index rebuild -c /var/ckan/ckan.ini
</code></pre></div>
<blockquote>
<p>Rebuilding the entire search index immediately removes all records from the search before re-indexing
begins.  No datasets will be served from the <code>package_search</code> API endpoint until the re-index has
completed.  This command should therefore only be used as a last resort since it will cause the sync
process to assume there is no data for a period of time.</p>
</blockquote>
<p>Only reindex those packages that are not currently indexed:</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckan search-index -o rebuild -c /var/ckan/ckan.ini
</code></pre></div><h3 id='csw-endpoint'><code>csw</code> endpoint</h3><p>The <code>csw</code> endpoint should be available on <a href="https://data.gov.uk/csw">https://data.gov.uk/csw</a> which
should redirect to <a href="https://ckan.publishing.service.gov.uk/csw">https://ckan.publishing.service.gov.uk/csw</a>.</p>
<h4 id='csw-endpoint-unavailable'><code>csw</code> endpoint unavailable</h4><p>If it is not showing xml with an error <code>Missing keyword: service</code> you can check
that it is running on the <code>ckan</code> machine:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>service pycsw_web-procfile-worker status
pycsw_web-procfile-worker start/running

<span class="nv">$ $ </span>ps aux | <span class="nb">grep </span>pycsw
root     29503  0.0  0.0  59652  2040 ?        Ss   06:04   0:00 <span class="nb">sudo</span> <span class="nt">-u</span> deploy <span class="nt">-E</span> sh <span class="nt">-c</span> <span class="nv">PATH</span><span class="o">=</span>/usr/lib/rbenv/shims:<span class="nv">$PATH</span> <span class="nb">exec  </span>unicornherder <span class="nt">--gunicorn-bin</span> ./venv/bin/gunicorn <span class="nt">-p</span> /var/run/ckan/pycsw_unicornherder.pid <span class="nt">--</span> ckanext.datagovuk.pycsw_wsgi <span class="nt">--bind</span> localhost:<span class="k">${</span><span class="nv">PYCSW_PORT</span><span class="k">}</span> <span class="nt">--timeout</span> <span class="k">${</span><span class="nv">GUNICORN_TIMEOUT</span><span class="k">}</span> <span class="nt">--workers</span> <span class="k">${</span><span class="nv">GUNICORN_WORKER_PROCESSES</span><span class="k">}</span> <span class="nt">--log-file</span> /var/log/ckan/pycsw.out.log <span class="nt">--error-logfile</span> /var/log/ckan/pycsw.err.log 2&gt;&gt;<span class="s1">'/var/log/ckan/procfile_pycsw_web.err.log'</span> 1&gt;&gt;<span class="s1">'/var/log/ckan/procfile_pycsw_web.out.log'</span>
...
</code></pre></div><p>If no running processes are found then you can restart it using this command:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>service pycsw_web-procfile_worker restart
</code></pre></div><p>It is worth checking the <code>pycsw</code> logs to investigate why it failed:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /var/log/ckan/pycsw.err.log
</code></pre></div><p>You can get a summary of <code>csw</code> records available from this url https://ckan.publishing.service.gov.uk/csw?service=CSW&amp;version=2.0.2&amp;request=GetRecords&amp;typenames=csw:Record&amp;elementsetname=brief</p>
<h4 id='syncing-the-csw-records-with-ckan-datasets'>Syncing the <code>csw</code> records with <code>ckan</code> datasets</h4><p>Normally the sync between <code>csw</code> and <code>ckan</code> will start at 6 each day, but in
case it should fail or if the sync needs to happen sooner you can manually
trigger the sync after Solr has been reindexed.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>paster <span class="nt">--plugin</span><span class="o">=</span>ckanext-spatial ckan-pycsw load <span class="nt">-p</span> /var/ckan/pycsw.cfg <span class="nt">-u</span> http://localhost:3220
</code></pre></div><h3 id='harvesting'>Harvesting</h3><p>Although harvesters can mostly be managed from the <a href="https://data.gov.uk/harvest">user interface</a>, it is
sometimes easier to perform these tasks from the command line.</p>
<h4 id='list-current-jobs'>List current jobs</h4><p>Returns a list of currently running jobs.  This will contain the
JOB_ID necessary to cancel jobs.</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckanext-harvest harvester jobs -c /var/ckan/ckan.ini
</code></pre></div><p>It may be faster to run a SQL query to get the ID of a specific harvest job.
You can do this by running the command from <a href="#accessing-the-database">Accessing the database</a>
and passing a <code>-c</code> argument:</p>
<div class="highlight"><pre class="highlight plaintext"><code>&lt;psql_ckan_production_command&gt; -c "SELECT id FROM harvest_source WHERE name = '[NAME]'"
</code></pre></div><h4 id='find-the-harvest-source-of-a-dataset'>Find the harvest source of a dataset</h4><p>The harvest source of a dataset can be found using the CKAN API. Once you have
the slug of the dataset, you can go to the following URL:</p>
<div class="highlight"><pre class="highlight plaintext"><code>https://ckan.publishing.service.gov.uk/api/action/package_show?id=&lt;slug&gt;
</code></pre></div><p>In the JSON response there should be a <code>harvest</code> field which will tell you the
ID and name of the harvest source.</p>
<h4 id='get-the-status-of-a-harvester'>Get the status of a harvester</h4>
<ol>
<li>Login to <a href="https://ckan.org">CKAN</a> as a sysadmin user (credentials are available in the <code>govuk-secrets</code> password store, under <code>datagovuk/ckan</code>).</li>
<li>Navigate to the relevant harvester (use the &lsquo;Harvest&rsquo; button in the header).</li>
<li>You will see a list of the datasets imported by this harvest source.</li>
<li>Click the &lsquo;Manage&rsquo; button to get the status.</li>
<li>A summary of the current status will be shown.  Individual runs (and the error messages logged) can be access from the &lsquo;Jobs&rsquo; tab.</li>
</ol>
<h4 id='restart-a-harvest-job'>Restart a harvest job</h4>
<ol>
<li>Follow the steps to <a href="#get-the-status-of-a-harvester">get the status of a harvester</a>.</li>
<li>If the harvester is currently running, click the &lsquo;Stop&rsquo; button to stop it.
Once it has stopped, or if it is not currently running, click the &lsquo;Reharvest&rsquo; button.
You will know if the harvester is running because the &lsquo;Reharvest&rsquo; button will be disabled.</li>
</ol>
<p>If the harvest job is hanging and the &lsquo;Stop&rsquo; button is not responding, you will have to log on to the <code>ckan</code> machine to restart it:</p>

<ol>
<li>SSH into the ckan machine with <code>gds govuk connect -e production ssh ckan</code></li>
<li>Assume the deploy user - <code>sudo su deploy</code></li>
<li>Activate the virtual environment - <code>. /var/apps/ckan/venv/bin/activate</code></li>
<li>Run the harvest job manually - <code>paster --plugin=ckanext-harvest harvester run_test &lt;harvest source&gt; -c /var/ckan/ckan.ini</code>

<ul>
<li>where <code>harvest source</code> is from the url when visiting the harvest source page, it will be something like <code>cabinet-office</code></li>
</ul></li>
</ol>
<p>If the job fails to complete the ticket should be updated with comments and prioritised to low for the product owner to review.</p>
<h4 id='cancel-a-harvest-job'>Cancel a harvest job</h4>
<ol>
<li>Follow the steps to <a href="#get-the-status-of-a-harvester">get the status of a harvester</a>.</li>
<li>Click the &lsquo;Stop&rsquo; button to stop it.</li>
</ol>
<p>Sometimes a harvest job can get stuck and not complete, and it&rsquo;s not possible to cancel it through the UI.
You can get the <code>JOB_ID</code> from the harvest dashboard under &ldquo;Last Harvest Job&rdquo; (or from <a href="#listing-current-jobs">Listing current jobs</a>).</p>
<p>Then cancel the job by running:</p>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckanext-harvest harvester job_abort JOB_ID -c /var/ckan/ckan.ini
</code></pre></div><p>This can also be done by running SQL:</p>
<div class="highlight"><pre class="highlight plaintext"><code>&lt;psql_ckan_production_command&gt; -c "UPDATE harvest_job SET finished = NOW(), status = 'Finished' WHERE source_id = '[UUID]' AND NOT status = 'Finished';"
</code></pre></div><h4 id='purging-all-currently-queued-tasks'>Purging all currently queued tasks</h4><p>It may be necessary, if there is a schedule clash and the system is too busy,
to purge the queues used in the various stages of harvesting</p>

<blockquote>
<p><strong>WARNING</strong></p>
<p>This command will empty the Redis queues</p>
</blockquote>
<div class="highlight"><pre class="highlight plaintext"><code>paster --plugin=ckanext-harvest harvester purge_queues -c /var/ckan/ckan.ini
</code></pre></div><h4 id='restarting-the-harvest-service'>Restarting the harvest service</h4><p>The harvesting process runs as a single threaded program, if any harvesting
process crashes by raising an exception, it will take out the entire process.
We have configured Upstart to restart the process automatically, but if the
service keeps crashing, Upstart will decide it&rsquo;s unhealthy and stop that after
a while.</p>
<p>You can check whether the process is still running by checking if entries are
still being written to the log file on the <code>ckan</code> machine:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>gds govuk connect <span class="nt">-e</span> production ssh ckan
<span class="nv">$ </span><span class="nb">sudo tail</span> <span class="nt">-f</span> /var/log/ckan/procfile_harvester_fetch_consumer.err.log
</code></pre></div><p>Or you could check that the services are all showing as <code>started</code> on the <code>ckan</code>
machine:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>initctl list | <span class="nb">grep </span>harvester
</code></pre></div><p>If any of the services are not showing as <code>started</code>, you will need to restart
them. There are both &lsquo;gather&rsquo; and &lsquo;fetch&rsquo; jobs that may need restarting:</p>
<p>&lsquo;Gather&rsquo; jobs retrieve the identifiers of the updated datasets and create jobs
in the fetch queue. To restart, run:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo initctl restart harvester_gather_consumer-procfile-worker
</code></pre></div><p>&lsquo;Fetch&rsquo; jobs retrieve the datasets from the remote source and perform the relevant
updates in CKAN. To restart, run:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo initctl restart harvester_fetch_consumer-procfile-worker
</code></pre></div><p>Alternatively, if the server has stopped, there is a Fabric script that will restart
it for you. It will only restart if it detects the harvesting process is no longer
running, so is safe to run immediately if you suspect the process has crashed:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>fab aws_production class:ckan ckan.restart_harvester
</code></pre></div><h3 id='ckan-publisher-on-staging-environment-responds-with-nginx-504-timeout'>CKAN publisher on Staging environment responds with Nginx 504 timeout:</h3><p>Sometimes CKAN publisher on Staging environment responds with a 504 from Nginx, this is due to it timing out when connecting to the database as there are too many connections, current limit is 1000, though under normal working the number of connections should be under 100 if the system is not under load testing.</p>
<div class="highlight"><pre class="highlight plaintext"><code>SELECT rolname, rolconnlimit FROM pg_roles WHERE rolname='ckan';`
</code></pre></div><h4 id='changing-the-connection-limit'>Changing the connection limit</h4><p>The connection limit can be updated, but should not exceed the hard limit which is around 3000.</p>
<div class="highlight"><pre class="highlight plaintext"><code>ALTER USER ckan WITH CONNECTION LIMIT 1001;
</code></pre></div><h4 id='trying-to-log-on-to-the-database-will-result-in-this-error'>Trying to log on to the database will result in this error:</h4><div class="highlight"><pre class="highlight plaintext"><code>FATAL:  too many connections for role "ckan"
</code></pre></div><h4 id='log-in-as-another-user'>Log in as another user:</h4><div class="highlight"><pre class="highlight plaintext"><code>sudo psql -U aws_db_admin -h postgresql-primary --no-password -d ckan_production
</code></pre></div><h4 id='view-the-number-of-connections-and-types-of-queries'>View the number of connections and types of queries:</h4><div class="highlight"><pre class="highlight plaintext"><code>SELECT COUNT(*) FROM pg_stat_activity WHERE datname = 'ckan_production';
</code></pre></div><h4 id='it-has-been-observed-that-during-an-overnight-sync-one-of-the-queries-caused-a-large-number-of-db-connections'>It has been observed that during an overnight sync one of the queries caused a large number of db connections:</h4><p>The following query captures part of that query and uses it to target the pid:</p>
<div class="highlight"><pre class="highlight plaintext"><code>SELECT pid FROM pg_stat_activity WHERE datname = 'ckan_production' and query LIKE 'SELECT "user".password AS user_password%';
</code></pre></div><h4 id='to-cancel-these-queries'>To cancel these queries</h4><div class="highlight"><pre class="highlight plaintext"><code>SELECT pg_cancel_backend(pid)
FROM pg_stat_activity
WHERE pid IN
(SELECT pid
FROM pg_stat_activity
WHERE datname = 'ckan_production' and query LIKE 'SELECT "user".password AS user_password%');
</code></pre></div><h4 id='to-identify-long-running-queries'>To identify long running queries</h4><div class="highlight"><pre class="highlight plaintext"><code>SELECT
pid,
now() - pg_stat_activity.query_start AS duration,
query,
state
FROM pg_stat_activity
WHERE
(now() - pg_stat_activity.query_start) &gt; interval '5 minutes' AND
datname = 'ckan_production';
</code></pre></div><h4 id='cancel-long-running-queries'>Cancel long running queries</h4><p>This will take a few seconds to be processed</p>
<div class="highlight"><pre class="highlight plaintext"><code>SELECT pg_cancel_backend(pid)
FROM pg_stat_activity
WHERE
(now() - pg_stat_activity.query_start) &gt; interval '5 minutes' AND
state = 'active' AND
datname = 'ckan_production';
</code></pre></div><h4 id='if-cancelling-does-not-work-you-can-terminate-the-query'>If cancelling does not work you can terminate the query</h4><p>Note - this must be used with caution as may cause the database to restart to recover consistency.</p>
<div class="highlight"><pre class="highlight plaintext"><code>SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE
(now() - pg_stat_activity.query_start) &gt; interval '5 minutes' AND
state = 'active' AND
datname = 'ckan_production';
</code></pre></div>

  <div class='related-content'>

    <h3>More in the data.gov.uk section</h3>

    <div class='govuk-grid-row'>
        <div class='govuk-grid-column-one-half'>
          <h4>Learn</h4>

          <ul class="govuk-list">
            <li><a href="/manual/data-gov-uk-architecture.html">Architecture of data.gov.uk</a></li>
            <li><a href="/manual/data-gov-uk-contracts-archive.html">Data.gov.uk Contracts Archive</a></li>
            <li><a href="/manual/data-gov-uk-map-previews.html">WMS map previews on data.gov.uk</a></li>
          </ul>
        </div>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/data-gov-uk-2nd-line.html">Common 2nd line support tasks for data.gov.uk</a></li>
            <li><a href="/manual/data-gov-uk-deployment.html">Deployments for data.gov.uk</a></li>
            <li><a href="/manual/data-gov-uk-monitoring.html">Monitor data.gov.uk</a></li>
            <li><a href="/manual/data-gov-uk-operations.html">Operation of data.gov.uk</a></li>
          </ul>
        </div>

    </div>
</div>


              <div data-module='page-expiry' data-last-reviewed-on="2020-09-05">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 5 March 2020.

        It needs to be reviewed again on 5 September 2020
        by the page owner <a href="">#govuk-platform-health</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 5 September 2020
       by the page owner <a href="">#govuk-platform-health</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/data-gov-uk-supporting-ckan.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Support%20tasks%20for%20CKAN'&amp;body=Problem%20with%20'Support%20tasks%20for%20CKAN'%20(https://docs.publishing.service.gov.uk/manual/data-gov-uk-supporting-ckan.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
