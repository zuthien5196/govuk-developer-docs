


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Jenkins CI infrastructure - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/jenkins-ci.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Jenkins CI infrastructure" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/jenkins-ci.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Jenkins CI infrastructure - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/jenkins-ci.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Jenkins CI infrastructure</span></a>
    <ul>
      <li>
        <a href="#introduction"><span>Introduction</span></a>
      </li>
      <li>
        <a href="#systems-diagram"><span>Systems diagram</span></a>
      </li>
      <li>
        <a href="#access"><span>Access</span></a>
      </li>
      <li>
        <a href="#configuration"><span>Configuration</span></a>
        <ul>
          <li>
            <a href="#configuration-management"><span>Configuration Management</span></a>
          </li>
          <li>
            <a href="#manual-configuration"><span>Manual configuration</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#on-the-blog"><span>On the blog</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
  <p><a href='/manual.html#testing'>Testing</a></p> <h1 id='header'>Jenkins CI infrastructure</h1><h2 id='introduction'>Introduction</h2><p>Our CI environment provides the infrastructure and services to cover the
first stages of our build and continuous deployment pipeline:</p>

<ul>
<li>Build application, Puppet and infrastructure projects from our GitHub organisation</li>
<li>Run unit, functional, performance tests</li>
<li>Update the status of the build in GitHub</li>
<li>Trigger deployment jobs on our Deployment infrastructure</li>
</ul>
<h2 id='systems-diagram'>Systems diagram</h2><p>Components:</p>

<ul>
<li>The CI environment runs in the Integration environment in the &ldquo;CI&rdquo; vDC</li>
<li>Jenkins master:

<ul>
<li>Nginx, listening on port 443, serves <a href="https://ci.integration.publishing.service.gov.uk">https://ci.integration.publishing.service.gov.uk</a>
and proxies requests to Jenkins. It is also running on port 80 to serve a monitoring page.</li>
<li>Jenkins master, listening on port 8080</li>
</ul></li>
<li>Jenkins agents:

<ul>
<li>The master instance connects with the agent box via SSH to manage the process</li>
<li>The agent machines run a set of services for application tests. Not all the boxes run
the same services, this is managed with Puppet. Check the <code>govuk_ci::master::ci_agents</code> label keys in
<a href="https://github.com/alphagov/govuk-puppet/blob/master/hieradata/common.yaml">Hiera</a> for more information.</li>
</ul></li>
<li>Supporting services:

<ul>
<li>An <a href="https://ci-alert.integration.publishing.service.gov.uk">Icinga instance</a> to monitor the
status of CI and the supporting infrastructure.</li>
<li>A <a href="https://ci-deploy.integration.publishing.service.gov.uk">Deploy Jenkins instance</a> to deploy Puppet
in to the environment and run any other adhoc tasks.</li>
<li><a href="https://ci-graphite.integration.publishing.service.gov.uk">Graphite</a> and <a href="https://ci-grafana.integration.publishing.service.gov.uk">Grafana</a>
for metrics in the environment.</li>
<li>Puppetmaster which deploys the latest version of [https://github.com/alphagov/govuk-puppet].</li>
<li>Apt instance for Gemstash</li>
</ul></li>
</ul>
<p><a href="images/ci_infrastructure.png" target="_blank" rel="noopener noreferrer"><img src="/manual/images/ci_infrastructure.png" alt="image" /></a></p>
<h2 id='access'>Access</h2><p>SSH to a random CI machine with <code>gds govuk connect ssh -e ci ci-agent</code>.
If you know the agent you want, append <code>:number</code> to the end of
<code>ci_agent</code> to go straight to that machine.</p>
<h2 id='configuration'>Configuration</h2><h3 id='configuration-management'>Configuration Management</h3><p>The configuration for CI resides in <a href="https://github.com/alphagov/govuk-puppet/tree/master/modules/govuk_ci">govuk-puppet</a>.</p>
<h3 id='manual-configuration'>Manual configuration</h3><h4 id='set-up-jenkins-credentials'>Set up Jenkins credentials</h4><p>The credentials plugin allows us to store credentials in Jenkins that can be retrieved later by other plugins
via API. At the moment these credentials are configured manually because Jenkins encrypts the secrets in a
credentials.xml file, so we can&rsquo;t replicate the encryption with Puppet. The <a href="https://forge.puppet.com/rtyler/jenkins">Jenkins Puppet module</a>
can manage credentials via Jenkins CLI, but currently not all types of credentials are supported.</p>
<p>To configure our credentials manually, from the Jenkins Credentials section add the following entries:</p>

<ul>
<li>GitHub token for govuk-ci

<ul>
<li>ID: github-token-govuk-ci</li>
<li>Type: Secret text</li>
<li>Description: GitHub token for govuk-ci</li>
<li>Scope: Global</li>
<li>Secret: <em>&lt;personal access token for govuk-ci user on GitHub&gt;</em></li>
</ul></li>
<li>GitHub token for govuk-ci with username

<ul>
<li>ID: github-token-govuk-ci-username</li>
<li>Type: Username with password</li>
<li>Description: GitHub token for govuk-ci with username</li>
<li>Scope: Global</li>
<li>Username: govuk-ci</li>
<li>Password: <em>&lt;personal access token for govuk-ci user on GitHub&gt;</em></li>
</ul></li>
<li>govuk-ci SSH key

<ul>
<li>ID: govuk-ci-ssh-key</li>
<li>Type: SSH Username with private key</li>
<li>Description: govuk-ci SSH key</li>
<li>Scope: Global</li>
<li>Username: govuk-ci</li>
<li>Private Key: From the Jenkins master ~/.ssh</li>
<li>Passphrase: <em>&lt;private key passphrase&gt;</em></li>
</ul></li>
<li>Pact broker creds for ci.dev.publishing.service.gov.uk

<ul>
<li>ID: pact-broker-ci-dev</li>
<li>Type: Username with password</li>
<li>Description: Pact broker creds for ci.dev.publishing.service.gov.uk</li>
<li>Scope: Global</li>
<li>Username: pact_ci</li>
<li>Password: <em>&lt;pact_ci user password on ci.dev.publishing.service.gov.uk&gt;</em></li>
</ul></li>
<li>Jenkins user that connects to SSH slaves

<ul>
<li>ID: jenkins-ssh-slave</li>
<li>Type: SSH Username with private key</li>
<li>Description: Jenkins user that connects to SSH slaves</li>
<li>Scope: Global</li>
<li>Username: jenkins</li>
<li>Private Key: From the Jenkins master ~/.ssh</li>
<li>Passphrase: <em>&lt;private key passphrase&gt;</em></li>
</ul></li>
</ul>
<p>The credential IDs are referenced in our Puppet code, we shouldn&rsquo;t update this field without checking first.</p>
<h4 id='set-up-github-repositories'>Set up GitHub repositories</h4><p>We use this with the GitHub and GitHub Branch Source plugins to define the source code repositories of
our jobs.</p>

<ol>
<li> Manage Jenkins -&gt; Configure Global Security

<ul>
<li>  GitHub -&gt; Add GitHub Server

<ul>
<li>  API URL: &lsquo;https://api.github.com&rsquo;</li>
<li>  Credentials: select &lsquo;GitHub token for govuk-ci&rsquo;</li>
<li>  Untick &lsquo;Manage hooks&rsquo;</li>
<li>  Click &lsquo;Test connection&rsquo; to confirm the settings</li>
</ul></li>
</ul></li>
</ol>
<p>With this configuration, in our jobs we can use &lsquo;GitHub&rsquo; API endpoints to
access the source code repository. The API endpoint name is referenced in
Puppet to configure jobs automatically so we shouldn&rsquo;t update it.</p>
<h2 id='on-the-blog'>On the blog</h2>
<ul>
<li><a href="https://gdstechnology.blog.gov.uk/2017/02/10/updating-the-gov-uk-continuous-integration-environment/">Updating the GOV.UK Continuous Integration environment</a></li>
</ul>


  <div class='related-content'>

    <h3>More in the Testing section</h3>

    <div class='govuk-grid-row'>
        <div class='govuk-grid-column-one-half'>
          <h4>Learn</h4>

          <ul class="govuk-list">
            <li><a href="/manual/brakeman.html">Brakeman</a></li>
            <li><a href="/manual/pact-broker.html">Pact Broker</a></li>
          </ul>
        </div>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/test-and-build-a-project-on-jenkins-ci.html">Test & build a project on Jenkins CI</a></li>
            <li><a href="/manual/test-and-build-a-project-with-github-actions.html">Test & build a project with GitHub Actions</a></li>
            <li><a href="/manual/troubleshooting-jenkins-performance.html">Troubleshoot CI Jenkins Performance</a></li>
            <li><a href="/manual/publishing-e2e-tests.html">Work with the end to end publishing tests</a></li>
          </ul>
        </div>

    </div>
</div>


              <div data-module='page-expiry' data-last-reviewed-on="2020-08-26">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 26 February 2020.

        It needs to be reviewed again on 26 August 2020
        by the page owner <a href="">#govuk-developers</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 26 August 2020
       by the page owner <a href="">#govuk-developers</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/jenkins-ci.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Jenkins%20CI%20infrastructure'&amp;body=Problem%20with%20'Jenkins%20CI%20infrastructure'%20(https://docs.publishing.service.gov.uk/manual/jenkins-ci.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
