


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Remove a machine - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/remove-machines.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Remove a machine" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/remove-machines.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Remove a machine - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/remove-machines.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Remove a machine</span></a>
    <ul>
      <li>
        <a href="#carrenza"><span>Carrenza</span></a>
      </li>
      <li>
        <a href="#1-remove-the-node-from-the-puppetmaster"><span>1. Remove the node from the puppetmaster</span></a>
        <ul>
          <li>
            <a href="#2-remove-from-vcloud-director"><span>2. Remove from vCloud Director</span></a>
          </li>
          <li>
            <a href="#3-remove-from-govuk-provisioning"><span>3. Remove from govuk-provisioning</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#aws"><span>AWS</span></a>
        <ul>
          <li>
            <a href="#1-remove-from-terraform"><span>1. Remove from Terraform</span></a>
          </li>
          <li>
            <a href="#2-remove-the-node-from-the-puppetmaster"><span>2. Remove the node from the puppetmaster</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#removing-a-class-of-machine"><span>Removing a class of machine</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
  <p><a href='/manual.html#infrastructure'>Infrastructure</a></p> <h1 id='header'>Remove a machine</h1><p>Before you start, make sure that the machines you are removing are no longer
needed for anything.</p>
<h2 id='carrenza'>Carrenza</h2><h2 id='1-remove-the-node-from-the-puppetmaster'>1. Remove the node from the puppetmaster</h2><p>You need to remove the nodes from the puppetmaster in each environment.
This is needed to clean up exported resources from Puppet, including
removing checks from Icinga.</p>
<p>First, disable Puppet on the machines you wish to remove.</p>
<p>Next, SSH into the puppetmaster for the environment:</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">$</span><span class="w"> </span>ssh puppetmaster-1.management.production
</code></pre></div><p>Then run this on each machine:</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">$</span><span class="w"> </span>govuk_node_clean &lt;machine_name&gt;
</code></pre></div><p>Where <code>&lt;machine_name&gt;</code> might be <code>machine-name-1.vdc-name.production</code> (Carrenza)
To find the names of the machines, you can list the nodes on puppetmaster:</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>puppet cert list <span class="nt">--all</span>
</code></pre></div><p>If <code>govuk_node_clean</code> was successful, you will get output like:</p>
<div class="highlight"><pre class="highlight shell"><code>Submitted <span class="s1">'deactivate node'</span> <span class="k">for </span>redirector-1.redirector.production with UUID 0fb445ff-d660-41eb-b6d2-eca40447d4bf
Notice: Revoked certificate with serial 127
Notice: Removing file Puppet::SSL::Certificate redirector-1.redirector.production at <span class="s1">'/etc/puppet/ssl/ca/signed/redirector-1.redirector.production.pem'</span>
</code></pre></div><p>After this, Icinga will forget about the machine when it next
runs Puppet. You can force this with:</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">$</span><span class="w"> </span>ssh monitoring-1.management.production
<span class="gp">$</span><span class="w"> </span>govuk_puppet <span class="nt">--test</span>
</code></pre></div><p>You may need to wait a few minutes, but it should then disappear from
the &ldquo;Host Detail&rdquo; page in Icinga.</p>
<h3 id='2-remove-from-vcloud-director'>2. Remove from vCloud Director</h3><p>Sign in to the vCloud Director instance for the given environment.
Go to &lsquo;My Cloud&rsquo;, search for the given machine, stop it, and then
delete it.</p>
<h3 id='3-remove-from-govuk-provisioning'>3. Remove from govuk-provisioning</h3><p>If your machine class matches a vDC, be careful not to remove firewall
rules that apply to the vDC.</p>
<h2 id='aws'>AWS</h2><h3 id='1-remove-from-terraform'>1. Remove from Terraform</h3><p>If you&rsquo;re removing a class of machines, first <a href="/manual/deploying-terraform.html#ci-jenkins">deploy Terraform</a>
for the relevant project using the <code>destroy</code> action. This will remove all the
EC2 instances.</p>
<p>Then, remove the project itself from <a href="https://github.com/alphagov/govuk-aws/tree/master/terraform/projects">govuk-aws</a>.</p>
<p>If you&rsquo;re removing a single machine, change the <code>asg_size</code> for the
relevant project in <a href="https://github.com/alphagov/govuk-aws-data/tree/master/data">govuk-aws-data</a>
(<a href="https://github.com/alphagov/govuk-aws-data/blob/master/data/app-whitehall-backend/production/common.tfvars#L4">example</a>) and deploy Terraform.  Unlike
Carrenza, it is not possible to disable alerts for the machine before
it is removed, as the ASG will terminate arbitrary instances to shrink
to the desired size.</p>
<p>If there are particular machines in the ASG that you do not want terminated
you can enable &ldquo;Scale in Protection&rdquo; on them before you reduce the size of the ASG. You
can find <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-instance-termination.html">more information on this in the AWS Docs</a>.</p>
<h3 id='2-remove-the-node-from-the-puppetmaster'>2. Remove the node from the puppetmaster</h3><p>Icinga will forget about the machine after Puppet runs on the
puppetmaster and then on the monitoring machine, which could be up to
an hour.  You can force this by running Puppet on the puppetmaster:</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">$</span><span class="w"> </span>gds govuk connect <span class="nt">-e</span> &lt;environment&gt; ssh puppetmaster
<span class="gp">$</span><span class="w"> </span>govuk_puppet <span class="nt">--verbose</span>
</code></pre></div><p>And then on the monitoring machine:</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">$</span><span class="w"> </span>gds govuk connect <span class="nt">-e</span> &lt;environment&gt; ssh monitoring
<span class="gp">$</span><span class="w"> </span>govuk_puppet <span class="nt">--verbose</span>
</code></pre></div><h2 id='removing-a-class-of-machine'>Removing a class of machine</h2><p>If you are removing a class of machines, you will need to <a href="https://github.com/alphagov/govuk-puppet/commit/8a971370a4b35de09a2e1a83ce3421f41f5d0520">remove the definitions</a> from Puppet.</p>


  <div class='related-content'>

    <h3>More in the Infrastructure section</h3>

    <div class='govuk-grid-row'>
        <div class='govuk-grid-column-one-half'>
          <h4>Learn</h4>

          <ul class="govuk-list">
            <li><a href="/manual/govuk-app-domain-handling-during-migration.html">app_domain handling in GOV.UK during migration to AWS</a></li>
            <li><a href="/manual/concourse.html">Concourse</a></li>
            <li><a href="/manual/dns.html">Domain Name System (DNS) records</a></li>
            <li><a href="/manual/vpn.html">GOV.UK and Virtual Private Networks (VPNs)</a></li>
            <li><a href="/manual/environments.html">GOV.UK's environments (integration, staging, production)</a></li>
            <li><a href="/manual/load-testing.html">Load Testing</a></li>
            <li><a href="/manual/upgrade-terraform.html">Upgrade Terraform</a></li>
          </ul>
        </div>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/adding-disks-in-vcloud.html">Add a disk to a vCloud machine (Carrenza only)</a></li>
            <li><a href="/manual/ruby.html">Add a new Ruby version</a></li>
            <li><a href="/manual/connect-to-vcloud-director.html">Connect to vCloud Director (Carrenza only)</a></li>
            <li><a href="/manual/generate-csr.html">Generate a Certificate Signing Request (CSR) for GOV.UK</a></li>
            <li><a href="/manual/rabbitmq.html">Manage RabbitMQ</a></li>
            <li><a href="/manual/auto-scaling-groups.html">Manually resize ASGs (auto scaling groups)</a></li>
            <li><a href="/manual/move-apps-between-servers.html">Move apps between servers</a></li>
            <li><a href="/manual/patching-jenkins.html">Patch Jenkins</a></li>
            <li><a href="/manual/provision-machines-for-data-science-research.html">Provision machines for data science research</a></li>
            <li><a href="/manual/alerts/rebooting-machines.html">Reboot a machine</a></li>
            <li><a href="/manual/renew-a-tls-certificate.html">Renew a TLS certificate for GOV.UK</a></li>
            <li><a href="/manual/reprovision.html">Reprovision a machine</a></li>
          </ul>
        </div>

    </div>
</div>


              <div data-module='page-expiry' data-last-reviewed-on="2020-11-13">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 13 May 2020.

        It needs to be reviewed again on 13 November 2020
        by the page owner <a href="">#re-govuk</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 13 November 2020
       by the page owner <a href="">#re-govuk</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/remove-machines.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Remove%20a%20machine'&amp;body=Problem%20with%20'Remove%20a%20machine'%20(https://docs.publishing.service.gov.uk/manual/remove-machines.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
