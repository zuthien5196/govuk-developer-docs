


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Our content delivery network (CDN) - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/cdn.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Our content delivery network (CDN)" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/cdn.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Our content delivery network (CDN) - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/cdn.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Our content delivery network (CDN)</span></a>
    <ul>
      <li>
        <a href="#cdn-configuration"><span>CDN configuration</span></a>
      </li>
      <li>
        <a href="#fastly-caching"><span>Fastly Caching</span></a>
      </li>
      <li>
        <a href="#fastly39s-ip-ranges"><span>Fastly’s IP ranges</span></a>
      </li>
      <li>
        <a href="#banning-ip-addresses-at-the-cdn-edge"><span>Banning IP addresses at the CDN edge</span></a>
      </li>
      <li>
        <a href="#bouncer39s-fastly-service"><span>Bouncer’s Fastly service</span></a>
        <ul>
          <li>
            <a href="#new-solution-for-bouncer-and-fastly"><span>New solution for Bouncer and Fastly</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
  <p><a href='/manual.html#cdn-caching'>CDN & Caching</a></p> <h1 id='header'>Our content delivery network (CDN)</h1><p>GOV.UK uses Fastly as a CDN. Public users aren&rsquo;t accessing GOV.UK servers directly, they connect via the CDN. This is better because:</p>

<ul>
<li>The CDN &ldquo;edge nodes&rdquo; (webservers) are closer to end users. Fastly has servers all around the world but our &ldquo;origin&rdquo; servers are only in the UK.</li>
<li>It reduces load on our origin. Fastly uses Varnish to cache responses.</li>
</ul>
<p>The CDN is responsible for retrying requests against the <a href="/manual/fall-back-to-mirror.html">static mirror</a>.</p>
<p><a href="images/cdn-mirror-configuration.png" target="_blank" rel="noopener noreferrer"><img src="/manual/images/cdn-mirror-configuration.png" alt="image" /></a></p>
<h2 id='cdn-configuration'>CDN configuration</h2><p>Most of the CDN config is versioned and scripted:</p>

<ul>
<li><a href="https://github.com/alphagov/govuk-cdn-config/">CDN configuration</a></li>
<li><a href="https://github.com/alphagov/govuk-cdn-config-secrets">CDN config secrets</a></li>
</ul>
<p>These are deployed to <a href="https://deploy.integration.publishing.service.gov.uk/job/Deploy_CDN/">integration</a>, <a href="https://deploy.staging.publishing.service.gov.uk/job/Deploy_CDN/">staging</a> and <a href="https://deploy.publishing.service.gov.uk/job/Deploy_CDN/">production</a>.</p>
<p>Some configuration isn&rsquo;t scripted, such as logging. The www, bouncer and assets services send logs to S3 which can be <a href="/manual/query-cdn-logs.html">queried</a>. These logging endpoints are configured directly in the Fastly UI.</p>
<h2 id='fastly-caching'>Fastly Caching</h2><p>The main www.gov.uk cache is <a href="https://varnish-cache.org/docs/2.1/index.html">Varnish</a>, which Fastly runs for us.</p>
<p>Varnish lets us configure our caching logic with VCL (Varnish config language).</p>
<p>It also lets us do fancy things, like <a href="https://github.com/alphagov/govuk-cdn-config/blob/f6cf15e9155f7c2ea89970741d3e03851a00013d/vcl_templates/www.vcl.erb#L202">only allowing connections to staging from permitted IPs</a>, <a href="https://github.com/alphagov/govuk-cdn-config/blob/f6cf15e9155f7c2ea89970741d3e03851a00013d/vcl_templates/www.vcl.erb#L222">forcing SSL</a> and <a href="https://github.com/alphagov/govuk-cdn-config/blob/f6cf15e9155f7c2ea89970741d3e03851a00013d/vcl_templates/www.vcl.erb#L208">blocking IP addresses</a>, among other things.</p>
<p>We set a default TTL of 3600s on cached objects. This means that pages such as the GOV.UK homepage will be cached for 1 hour. 5XX responses get cached for 1s; mirror responses get cached for 15 minutes.</p>
<p>We also set a grace period of 24 hours. So if the homepage server is down, we&rsquo;ll continue to serve a stale homepage for 24 hours.</p>
<p>These are the GET request status codes that Varnish caches automatically: 200, 203, 300, 301, 302, 404 or 410. (See the <a href="https://varnish-cache.org/docs/2.1/reference/vcl.html#variables">Varnish docs</a> for more detail.)</p>
<p>We have added to these - see the <a href="https://github.com/alphagov/govuk-cdn-config/">GOV.UK CDN Config repo</a> VCL for special handling of certain status codes, and for the most up-to-date version of what we&rsquo;re running in Fastly. Refer to the Varnish 2.1 documentation when looking at the VCL code.</p>
<p><strong>Testing VCL</strong></p>
<p>VCL can be tricky to get right. When making changes to the VCL, add smoke tests <a href="https://github.com/alphagov/smokey/blob/master/features/caching.feature">to smokey</a> and check that they don&rsquo;t fail in staging.</p>
<p>You can also use Fastly&rsquo;s <a href="https://fiddle.fastlydemo.net/">Fiddle tool</a> to manually test, and you can also test your changes with cURL by including a debug header:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>curl <span class="nt">-svo</span> /dev/null <span class="nt">-H</span> <span class="s2">"Fastly-Debug:1"</span> https://www.gov.uk
</code></pre></div><p>This will give you various debugging headers that may be useful:</p>
<div class="highlight"><pre class="highlight plaintext"><code>&lt; Fastly-Debug-Path: &lt;nodes you hit&gt;
&lt; Fastly-Debug-TTL: &lt;nodes with TTL&gt;
&lt; Fastly-Debug-Digest: &lt;hash&gt;
&lt; X-Served-By: &lt;node that responded&gt;
&lt; X-Cache: HIT, HIT
&lt; X-Cache-Hits: 1
&lt; X-Timer: &lt;time it took&gt;
&lt; Vary: Accept-Encoding, Accept-Encoding
</code></pre></div><p>See the Varnish/Fastly docs for what these mean. Check out the Fastly <a href="https://docs.fastly.com/guides/debugging/checking-cache#using-curl">debugging guide</a> for more details on testing.</p>
<h2 id='fastly39s-ip-ranges'>Fastly&rsquo;s IP ranges</h2><p>Fastly publish their cache node <a href="https://api.fastly.com/public-ip-list">IP address ranges as JSON from their API</a>. We use these IP addresses in 2 places:</p>

<ul>
<li>Origin has <a href="https://github.com/alphagov/govuk-provisioning/blob/master/vcloud-edge_gateway/vars/production_carrenza_vars.yaml">firewall rules</a> in place so that only our office and Fastly can connect.</li>
<li>Our <a href="https://github.com/alphagov/govuk-cdn-config/">Fastly Varnish config</a> restricts HTTP purges to specific IP addresses (otherwise anyone would be able to purge the cache).</li>
</ul>
<p>We have <a href="https://deploy.publishing.service.gov.uk/job/Check_CDN_IP_Ranges/">a Jenkins job &ldquo;Check CDN IP Ranges&rdquo;</a> which will start to fail if our Fastly IPs don&rsquo;t match the IPs returned from the Fastly API. If you see this alert, you can <a href="/manual/raising-issues-with-reliability-engineering.html">let Reliability Engineering know</a> and they will update our list of Fastly IPs to match the ones listed by Fastly.</p>
<p>Updating the firewall rules in Carrenza with new Fastly IPs used to be done by committing the change to the <a href="https://github.com/alphagov/govuk-provisioning">govuk-provisioning</a> repo and to then deploy the firewall through a Jenkins job. This process is broken at the moment since the code base has diverged from the state of the firewall. While this is remedied we have to add the new rules manually - this is how to do it:</p>

<ol>
<li>You will need to install <a href="https://github.com/vmware/vcd-cli">vcd-cli</a> to use the following scripts.</li>
<li>Connect to the <a href="/manual/connect-to-vcloud-director.html#connecting-with-cisco-anyconnect">Carrenza VPN</a></li>
<li>Login to Vcloud director, you can find the organisation name and the credentials attached to it in the password store.</li>
</ol>
<div class="highlight"><pre class="highlight shell"><code>vcd login vcloud.carrenza.com <span class="o">{</span>organisation<span class="o">}</span> 2nd-line-support@digital.cabinet-office.gov.uk <span class="nt">-V</span> 32.0
</code></pre></div>
<ol>
<li>Find the correct values for $stag_prefix and $prod_prefix in Carrenza and run this script, setting env to either staging or production and put the list of new Fastly IP ranges into fastly_ips as an array</li>
</ol>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">env</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">fastly_ips</span><span class="o">=()</span>

<span class="k">case</span> <span class="nv">$env</span> <span class="k">in</span>
        <span class="s2">"staging"</span><span class="p">)</span>
                <span class="nv">dests</span><span class="o">=(</span><span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.146 <span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.158 <span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.155 <span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.155 <span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.155 <span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.157 <span class="k">${</span><span class="nv">stag_prefix</span><span class="k">}</span>.149<span class="o">)</span>
                <span class="nv">gateway</span><span class="o">=</span><span class="s1">'0e7t-DR-GOVUK-Staging-gateway-LDN'</span>
                <span class="p">;;</span>
        <span class="s2">"production"</span><span class="p">)</span>
                <span class="nv">dests</span><span class="o">=(</span><span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.82 <span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.94 <span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.91 <span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.91 <span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.91 <span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.93 <span class="k">${</span><span class="nv">prod_prefix</span><span class="k">}</span>.85<span class="o">)</span>
                <span class="nv">gateway</span><span class="o">=</span><span class="s1">'0e7t-GOV_PRODUCTION-gateway01'</span>
                <span class="p">;;</span>
        <span class="k">*</span><span class="p">)</span>
                <span class="nb">echo</span> <span class="s2">"Environment should either be staging or production"</span>
                <span class="nb">exit </span>1
                <span class="p">;;</span>
<span class="k">esac</span>

<span class="nv">ports</span><span class="o">=(</span>443 443 6514 6515 6516 80 443<span class="o">)</span>
<span class="nv">names</span><span class="o">=(</span>origin API monitoring-1_GOV.UK monitoring-1_Assets monitoring-1_Bouncer apt_mirror Backend_AWS<span class="o">)</span>

<span class="nv">nb_rules</span><span class="o">=</span><span class="k">$((</span> <span class="k">${#</span><span class="nv">fastly_ips</span><span class="p">[@]</span><span class="k">}</span> <span class="o">*</span> <span class="m">7</span> <span class="k">))</span>
<span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">seq</span> <span class="nv">$nb_rules</span> <span class="nv">$END</span><span class="si">)</span>
<span class="k">do
        </span>vcd gateway services firewall create <span class="nt">--disabled</span> <span class="nt">--name</span> <span class="s2">"NewRule_</span><span class="nv">$i</span><span class="s2">"</span> <span class="nt">--action</span> accept <span class="nt">--type</span> user <span class="nv">$gateway</span>
<span class="k">done

</span><span class="nv">newrules_ids</span><span class="o">=(</span><span class="sb">`</span>vcd gateway services firewall list <span class="nv">$gateway</span> | <span class="nb">grep</span> <span class="s1">'NewRule_'</span> | <span class="nb">awk</span> <span class="s1">'{print $1'</span><span class="o">}</span><span class="sb">`</span><span class="o">)</span>

<span class="nb">seq</span><span class="o">=</span>0
<span class="k">for </span>ip <span class="k">in</span> <span class="k">${</span><span class="nv">fastly_ips</span><span class="p">[@]</span><span class="k">}</span>
<span class="k">do
        for </span>i <span class="k">in</span> <span class="sb">`</span><span class="nb">seq </span>0 6<span class="sb">`</span>
        <span class="k">do
                </span><span class="nv">name</span><span class="o">=</span><span class="s2">"'Fastly </span><span class="nv">$ip</span><span class="s2"> to </span><span class="k">${</span><span class="nv">names</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="k">}</span><span class="s2">'"</span>
                vcd gateway services firewall update <span class="nt">--enabled</span> <span class="nt">--name</span> <span class="nv">$name</span> <span class="nt">--source</span> <span class="nv">$ip</span>:ip <span class="nt">--destination</span> <span class="k">${</span><span class="nv">dests</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="k">}</span>:ip <span class="nt">--service</span> tcp any <span class="k">${</span><span class="nv">ports</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="k">}</span> <span class="nv">$gateway</span> <span class="k">${</span><span class="nv">newrules_ids</span><span class="p">[</span><span class="nv">$seq</span><span class="p">]</span><span class="k">}</span>
                <span class="nb">seq</span><span class="o">=</span><span class="k">$((</span><span class="nb">seq</span><span class="o">+</span><span class="m">1</span><span class="k">))</span>
        <span class="k">done
done</span>
</code></pre></div><h2 id='banning-ip-addresses-at-the-cdn-edge'>Banning IP addresses at the CDN edge</h2><p>We occasionally decide to ban an IP address at our CDN edge if they exhibit the following behaviour:</p>

<ul>
<li>not respecting <a href="https://www.gov.uk/robots.txt">our robots.txt directives</a></li>
<li>repeatedly receiving 429 (rate limit) error responses from origin and not slowing down</li>
<li>making suspicious requests like attempting SQL injection queries</li>
</ul>
<p>Banning IPs shouldn&rsquo;t be taken lightly as IP address can be shared by multiple user devices and the user behind an IP address can change over time, so there&rsquo;s always a chance that we may block a legitimate user.</p>
<p>You can change the list of banned IP addresses by modifying the <a href="https://github.com/alphagov/govuk-cdn-config-secrets/blob/master/fastly/dictionaries/config/ip_address_blacklist.yaml">YAML config file</a> and <a href="https://deploy.publishing.service.gov.uk/job/Update_CDN_Dictionaries/build">deploying the configuration</a>.</p>
<h2 id='bouncer39s-fastly-service'>Bouncer&rsquo;s Fastly service</h2><p>A Fastly CDN service can normally handle up to 1000 domains - this limit is currently undocumented.</p>
<p>We have asked them to increase this limit for Bouncer&rsquo;s service a few times as the number of domains it handled grew, and the limit is <a href="https://fastly.zendesk.com/requests/7356">currently 3500</a>. We have <a href="https://transition.publishing.service.gov.uk/hosts">about 2000 domains</a> so shouldn&rsquo;t need to increase it again for a while.</p>
<p>If we reach the limit then the <a href="https://deploy.blue.production.govuk.digital/job/Bouncer_CDN/">Jenkins job to update Bouncer&rsquo;s CDN config</a> should fail and new domains won&rsquo;t be added to the service.</p>
<p>Configuring a new site in Transition generally adds at least 4 domains to the service, including the <code>aka</code> domain for each real domain. For example:</p>

<ul>
<li>  <code>www.foo.gov.uk</code></li>
<li>  <code>aka.foo.gov.uk</code></li>
<li>  <code>foo.gov.uk</code></li>
<li>  <code>aka-foo.gov.uk</code></li>
</ul>
<h3 id='new-solution-for-bouncer-and-fastly'>New solution for Bouncer and Fastly</h3><p>Fastly&rsquo;s new solution to get around the domain limit is a &ldquo;service pinned map&rdquo;.</p>
<p>They have created a map which we access using <code>bouncer-cdn.production.govuk.service.gov.uk</code>. Domains that need to be transitioned can <code>CNAME</code> to this domain. It also has 4 IP addresses assigned, which at the time of writing are the same as the <code>A</code> records at that hostname:</p>

<ul>
<li><code>151.101.2.30</code></li>
<li><code>151.101.66.30</code></li>
<li><code>151.101.130.30</code></li>
<li><code>151.101.194.30</code></li>
</ul>
<p>Domains do not need to be added to the &ldquo;Production Bouncer&rdquo; Fastly service like they used to be.</p>


  <div class='related-content'>

    <h3>More in the CDN & Caching section</h3>

    <div class='govuk-grid-row'>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/purge-cache.html">Purge a page from cache</a></li>
            <li><a href="/manual/query-cdn-logs.html">Query CDN logs</a></li>
          </ul>
        </div>

    </div>
</div>


              <div data-module='page-expiry' data-last-reviewed-on="2020-08-11">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 11 February 2020.

        It needs to be reviewed again on 11 August 2020
        by the page owner <a href="">#govuk-developers</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 11 August 2020
       by the page owner <a href="">#govuk-developers</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/cdn.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Our%20content%20delivery%20network%20(CDN)'&amp;body=Problem%20with%20'Our%20content%20delivery%20network%20(CDN)'%20(https://docs.publishing.service.gov.uk/manual/cdn.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
