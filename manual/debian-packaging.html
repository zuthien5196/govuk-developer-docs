


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Manage Debian packages - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/debian-packaging.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Manage Debian packages" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/debian-packaging.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Manage Debian packages - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/debian-packaging.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Manage Debian packages</span></a>
    <ul>
      <li>
        <a href="#considerations-before-creating-or-importing-a-package"><span>Considerations before creating or importing a package</span></a>
        <ul>
          <li>
            <a href="#creating-and-maintaining-packages-locally"><span>Creating and maintaining packages locally</span></a>
          </li>
          <li>
            <a href="#mirroring-packages-maintained-by-a-third-party"><span>Mirroring packages maintained by a third party</span></a>
          </li>
          <li>
            <a href="#mirroring-or-importing-deb-packages-created-for-other-distributions-e-g-debian-linux-mint-etc"><span>Mirroring or importing .deb packages created for other distributions (e.g. Debian, Linux Mint, etc)</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#creating-packages"><span>Creating packages</span></a>
        <ul>
          <li>
            <a href="#launchpad"><span>Launchpad</span></a>
          </li>
          <li>
            <a href="#fpm"><span>fpm</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#uploading-a-new-package"><span>Uploading a new package</span></a>
      </li>
      <li>
        <a href="#mirroring"><span>Mirroring</span></a>
        <ul>
          <li>
            <a href="#setting-up-new-machine"><span>Setting up new machine</span></a>
          </li>
          <li>
            <a href="#local-repos"><span>Local repos</span></a>
          </li>
          <li>
            <a href="#third-party-repos"><span>Third-party repos</span></a>
          </li>
          <li>
            <a href="#ppas"><span>PPAs</span></a>
          </li>
          <li>
            <a href="#removing-mirrors-no-longer-in-use"><span>Removing mirrors no longer in use</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
  <p><a href='/manual.html#packaging'>Packaging</a></p> <h1 id='header'>Manage Debian packages</h1><p>This page explains how we manage our Debian packaging.</p>
<h2 id='considerations-before-creating-or-importing-a-package'>Considerations before creating or importing a package</h2><p>Due to limited availability of up-to-date packages in long term support (LTS)
distributions, requirements of software may make installation of a package
outside of the distribution infrastructure (currently Ubuntu &ldquo;Trusty&rdquo; 14.04
LTS/Extended Security Maintenance) necessary.</p>
<p>GDS developers may also choose to use the Debian packaging system as a means to
distribute and maintain their locally developed software.</p>
<p>As always when considering the addition of new software, the first question has to be:
<strong>&ldquo;Is this really necessary?&rdquo;</strong></p>
<p>Adding a package should be motivated by
security or architecture requirements and aim to minimise unnecessary
dependencies.</p>
<p>Additional guidance can be found in the <a href="https://gds-way.cloudapps.digital/standards/tracking-dependencies.html#dependency-management-tools">GDS way</a>
as well as the <a href="https://www.gov.uk/service-manual/technology/managing-software-dependencies#how-to-work-with-third-party-code">service manual</a>.</p>
<p>If you are satisfied that adding a local or third party package via aptly is the
optimal solution, there are a number of ways packages may be sourced and added,
all carrying different advantages and disadvantages as well as security and
maintenance implications.</p>
<h3 id='creating-and-maintaining-packages-locally'>Creating and maintaining packages locally</h3><p>See section <a href="#creating-packages">Creating Packages</a> for details on implementation.</p>

<ul>
<li><p>Creating local packages allows for the greatest flexibility with respect to
installation, default configuration and fullfilment of requirements.</p></li>
<li><p>Locally developed bug-fixes can be included and distributed independent of
distribution services.</p></li>
<li><p>Distribution bug-fixes and updates are not available and the package has to
be actively maintained by GOV.UK.</p></li>
<li><p>To minimise technical debt on future maintenance of packages, locally created
packages should only be considered if there is no reliable and secure third
party option available.</p></li>
</ul>
<h3 id='mirroring-packages-maintained-by-a-third-party'>Mirroring packages maintained by a third party</h3><p>See section <a href="#mirroring">Mirroring</a>, in particular <a href="#third-party-repos">Third-party Repos</a>
for details on implementation.</p>

<ul>
<li><p>If considering the use of a package created by a third party, the
trustworthiness of said party is critical.</p></li>
<li><p>General Debian packages explicitly labelled as suitable for Ubuntu Trusty,
such as <a href="https://www.postgresql.org/download/linux/ubuntu/">Ubuntu packages provided by PostgreSQL</a>
or <a href="https://launchpad.net/~libreoffice/+archive/ubuntu/ppa">PPA packages by LibreOffice</a>
can be considered safe.</p></li>
<li><p>With regard to packages provided by private contributors and/or smaller companies,
both the maturity of the software and trust for the source need to be evaluated.
Comments on maturity as well as the number of users of a package may be an
indicator of its suitability for use in production.</p></li>
<li><p>Development activity and update frequency are additional factors to consider.</p></li>
<li><p>When in doubt about the trustworthiness or stability of a third party package,
this option should be disregarded in favour of other solutions not
compromising on reliability and security.</p></li>
</ul>
<h3 id='mirroring-or-importing-deb-packages-created-for-other-distributions-e-g-debian-linux-mint-etc'>Mirroring or importing .deb packages created for other distributions (e.g. Debian, Linux Mint, etc)</h3><p>See section <a href="#creating-packages">Creating Packages</a> for details on implementation.</p>

<ul>
<li><p>If great care is taken, it may be possible to make use of a software version
which has been packaged for another Linux distribution, e.g. Debian.</p></li>
<li><p>Despite Ubuntu being based on Debian experimental, <strong>no Debian repository should ever
be directly mirrored and made available through aptly to a Ubuntu system</strong> <em>ever</em>.
There will be severe complications including failing or erroneous package upgrades,
broken dependencies and likely complete system failure.</p></li>
<li><p>The safest way to use packages of other distributions is to use source packages. See
the note in <a href="#third-party-repos">Third-party Repos</a> for an idea of how to use them.</p></li>
<li><p>Please note that resolution of building dependencies in source packages may not be possible or
require significant work.</p></li>
<li><p>The advantage of using source packages is that it ensures all library requirements of
the created binaries are met by the original distribution (Ubuntu).</p></li>
<li><p>This use of (current) Debian packages ensures updates and bug-fixes are
readily available. However, the creation and  maintenance of the build
environment may introduce significant overhead in itself.</p></li>
</ul>
<h2 id='creating-packages'>Creating packages</h2><p>In the past we&rsquo;ve used
<a href="https://github.com/alphagov/packager">alphagov/packager</a> to push builds
to <a href="https://launchpad.net/~gds/+archive/govuk">Launchpad</a>.</p>
<p>The new way we prefer to build packages is using
<a href="https://github.com/jordansissel/fpm">fpm</a> in the
<a href="https://github.com/alphagov/packager">alphagov/packager</a> repo.</p>
<h3 id='launchpad'>Launchpad</h3><p>We are using <a href="https://launchpad.net/~gds/+archive/govuk">Launchpad</a> as
the source of all our Debian packages and
<a href="https://github.com/alphagov/packager">alphagov/packager</a> which provides
an easy interface to build packages.</p>
<p><code>alphagov/packager</code> creates intermediate files
(.changes/.dsc) which can be uploaded to Launchpad and which uses the files
to build the Debian package. The README for the repository explains how
to create packages for Launchpad.</p>
<p>Once a package is imported (published) from a given source (e.g. the Nginx
package is published from <code>nginx-stable-testing</code>) it cannot be
republished/superseded (even if deleted and published again) from a
different source on the same version number. To do so the version has to
be bumped up.</p>
<h3 id='fpm'>fpm</h3><p>Add an fpm recipe to packager and then use <a href="https://ci.integration.publishing.service.gov.uk/job/build_fpm_package/">the Jenkins
job</a> to
create a Debian package.</p>
<h4 id='test-the-recipe'>Test the recipe</h4>
<ul>
<li>The Jenkins job will produce a <code>.deb</code> package in the <code>Build Artifacts</code>.</li>
<li>With Packager cloned to your local <code>govuk</code> folder, download your new package to
the Packager root folder.</li>
<li><p>Start the VM, move to the Packager project and run:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  $ sudo dpkg -i ./your_package_name.deb`
</code></pre></div></li>
<li><p>Ensure your package has been successfully installed.</p></li>
</ul>
<p>If successful, you can copy this package to the aptly machine and then add the
deb file to aptly.</p>
<h2 id='uploading-a-new-package'>Uploading a new package</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>The commands below should be run on the machine where aptly is
running.
The example used is for upgrading Ruby by adding a new package to the <code>rbenv-ruby</code> repository</p>
</blockquote>

<ol>
<li>Download the package to your local machine</li>
<li><p>Upload the package to the aptly machine:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  $ scp ~/Downloads/rbenv-ruby-2.6.1_1_amd64.deb username@&lt;inet_addr&gt;.&lt;environment&gt;:/home/username/
</code></pre></div></li>
<li><p>In the machine, add the package to the repo:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  $ sudo -i aptly repo add rbenv-ruby /home/username/rbenv-ruby-2.6.1_1_amd64.deb
    Loading packages...
    [+] rbenv-ruby-2.6.1_1_amd64 added
</code></pre></div></li>
<li><p>Create a snapshot:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  $ snapshot="rbenv-ruby-$(date +%Y%m%d)"
  $ sudo aptly snapshot create $snapshot from repo rbenv-ruby
    Snapshot rbenv-ruby-20190212 successfully created.

  $ sudo aptly snapshot show $snapshot
    Name: rbenv-ruby-20190212
    Created At: 2019-02-12 15:36:23 UTC
    Description: Snapshot from local repo [rbenv-ruby]
    Number of packages: 11
</code></pre></div></li>
<li><p>Check the package doesn&rsquo;t remove or replace a version we are currently using
by checking the diff. You can find the previous snapshot by running <code>sudo aptly snapshot list</code></p>
<div class="highlight"><pre class="highlight plaintext"><code>  $ sudo aptly snapshot diff rbenv-ruby-20181023 $snapshot
    Arch   | Package          | Version in A  | Version in B
  + amd64  | rbenv-ruby-2.6.1 | -             | 1

</code></pre></div></li>
<li><p>Publish the new snapshot, you will be prompted to enter the passphrase for our
APT account which is in <a href="https://github.com/alphagov/govuk-secrets/tree/master/pass">govuk-secrets</a> <code>./edit.sh 2ndline apt/passphrase</code></p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly publish switch trusty rbenv-ruby $snapshot
  Loading packages...
  Generating metadata files and linking package files...
  Finalizing metadata files...
  Publish for snapshot rbenv-ruby/trusty [amd64] publishes {main: [rbenv-ruby-20190212]: Snapshot from local repo [rbenv-ruby]} has been successfully switched to new snapshot.
</code></pre></div></li>
<li><p>You can check it has been published by going to <a href="https://apt.publishing.service.gov.uk/">https://apt.publishing.service.gov.uk</a>.
For this example navigate to <a href="https://apt.publishing.service.gov.uk/rbenv-ruby/pool/main/r/">https://apt.publishing.service.gov.uk/rbenv-ruby/pool/main/r/</a>. You can also test it works by running <code>apt-get</code> in one of the integration boxes:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  $ sudo apt-get install rbenv-ruby-2.6.1
</code></pre></div></li>
</ol>
<h2 id='mirroring'>Mirroring</h2><p>We are using <a href="http://www.aptly.info">aptly</a> to mirror third-party
repositories. We do this for:</p>
<p><strong>Availability</strong>: Our ability to provision new and deploy to existing machines
shouldn&rsquo;t be affected by the availability/uptime of another vendor/project.
This doesn&rsquo;t necessarily apply to Ubuntu upstream, who have a good network of
mirrors.</p>
<p><strong>Consistency</strong>:   We should be able to use a consistent set of package
versions across all environments. New versions should be staged in
when we choose to do so. This also guards us against some vendors/projects
who remove old packages without warning.</p>
<p><strong>Bandwidth</strong>:   This is the least important, but is good netizen practice. We
shouldn&rsquo;t need to go out to the internet every time we install a package.
Especially if we&rsquo;re doing it 40x for all hosts in an environment. We also
shouldn&rsquo;t hit them with <code>apt-get update</code> every 30mins.</p>
<p>We will describe some common operations here and add to it as we do more
complex things. However the upstream documentation and examples are also
very good.</p>

<blockquote>
<p><strong>Note</strong></p>
<p>The commands below should be run on the machine where aptly is
running. We publish to our preview mirror from our production aptly
machine.</p>
</blockquote>
<h3 id='setting-up-new-machine'>Setting up new machine</h3><p>These instructions are only to be used when setting up a new machine to
serve aptly repos.</p>
<p>We only manage <em>some</em> parts of aptly using Puppet, because it requires
GPG keys and passwords, and updating repositories is something that
should be done ad-hoc rather than on a regular schedule.</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ PASSWORD_STORE_DIR=~/govuk/deployment/pass/2ndline pass apt/key &gt; apt-1.management.key
</code></pre></div><p>Copy the <code>apt-1.management.key</code> file and import it on the aptly machine:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i gpg --import apt-1.management.key
</code></pre></div><p>When doing any of the <code>publish</code> actions below you will be prompted for
the password. This can be found in the same place. You will need to use
<code>sudo -i</code> for such actions, in order to reference root&rsquo;s GPG files.</p>

<blockquote>
<p><strong>WARNING</strong></p>
<p>Please make sure that you use <code>sudo</code> and NOT a root shell so we
have a record of the actions performed.</p>
</blockquote>
<h3 id='local-repos'>Local repos</h3><p>We maintain some local repos. These are typically used to manually
mirror an upstream repo where we need more than one version of a
package, and the upstream mirror removes old versions (eg Jenkins).</p>
<p>Recently the need to upgrade packages beyond versions maintained by the
Linux distribution (Currently Ubuntu 14.04 LTS Trusty) has arisen (The shipped
Python version 2.7.6 does not support current SSL anymore).</p>
<p>To avoid impact of custom built versions on the existing environment we prefix
these packages with &ldquo;govuk-&rdquo; (as in e.g. <code>govuk-python_2.7.14_amd64</code>) and aim
for installation in /opt. For a single dependency tree a new local repository
following the naming scheme, e.g. <code>govuk-python</code> to contain packages <code>govuk-python</code>
, <code>govuk-python-pip</code>, <code>govuk-python-setuptools</code>, etc.) should be created.</p>
<h4 id='initial-setup'>Initial setup</h4><p>After setting up a <code>aptly::repo</code> resource in Puppet (do not use
<code>aptly repo create</code>) you configure it, add packages and publish it to a
prefix with:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly repo edit -distribution="stable" govuk-jenkins
$ sudo -i aptly repo add govuk-jenkins /path/to/jenkins.deb
$ sudo aptly snapshot create govuk-jenkins-$(date +%Y%m%d) from repo govuk-jenkins
$ sudo -i aptly publish snapshot govuk-jenkins-$(date +%Y%m%d) govuk-jenkins
</code></pre></div><h4 id='updates'>Updates</h4><p>To add new packages download them, then add to the repo:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly repo add govuk-jenkins /path/to/jenkins_1.554.2_all.deb
</code></pre></div><p>To remove unused packages:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly repo remove govuk-jenkins 'jenkins (= 1.532.1)'
</code></pre></div><p>Create a new snapshot:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo aptly snapshot create govuk-jenkins-$(date +%Y%m%d) from repo govuk-jenkins
</code></pre></div><p>Confirm that the package changes look as expected and that it doesn&rsquo;t
remove/replace a version that we are currently using:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo aptly snapshot diff govuk-jenkins-20140101 govuk-jenkins-$(date +%Y%m%d)
  Arch   | Package     | Version in A  | Version in B
- amd64  | jenkins     | 1.532.1       | -
+ amd64  | jenkins     | -             | 1.554.2
</code></pre></div><p>Publish the new snapshot:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly publish switch stable govuk-jenkins govuk-jenkins-$(date +%Y%m%d)
</code></pre></div><p>Finally, since we cache the mirror with Fastly, you&rsquo;ll need to purge the
content in the UI:</p>

<blockquote>
<ol>
<li> Log in at <a href="https://app.fastly.com">https://app.fastly.com</a></li>
<li> Click the &lsquo;Configure&rsquo; tab along the top</li>
<li> Choose the &lsquo;Production Apt&rsquo; service from the dropdown</li>
<li> Click &lsquo;Purge&rsquo;, then &lsquo;Purge All&rsquo;</li>
</ol>
</blockquote>
<p>Note that whilst - typically - purging all is an expensive operation
(because requests will then hit origin until Fastly warms back up again,
which could take some time), in this case, the low amount, and type, of
traffic this service receives means it&rsquo;s safe.</p>
<h4 id='use-a-local-repo-in-an-app'>Use a local repo in an app</h4><p>To make a repository available on a machine it is necessary to include a class implementing
an <code>apt::source</code> object, e.g.:</p>
<div class="highlight"><pre class="highlight plaintext"><code>class govuk_python::repo (
  $apt_mirror_hostname = undef,
) {
  apt::source { 'govuk-python':
    location     =&gt; "http://${apt_mirror_hostname}/govuk-python",
    release      =&gt; $::lsbdistcodename,
    architecture =&gt; $::architecture,
    key          =&gt; 'DA1A4A13543B466853BAF164EB9B1D8886F44E2A';
  }
}
</code></pre></div><p>After this, packages can be included in the form:</p>
<div class="highlight"><pre class="highlight mosel"><code>  <span class="k">package</span> <span class="p">{</span> <span class="s1">'govuk-python'</span><span class="p">:</span>
    <span class="n">ensure</span>  <span class="p">=&gt;</span> <span class="p">$</span><span class="k">version</span><span class="p">,</span>
    <span class="n">require</span> <span class="p">=&gt;</span> <span class="n">Apt</span><span class="p">::</span><span class="n">Source</span><span class="p">[</span><span class="s1">'govuk-python'</span><span class="p">],</span>
  <span class="p">}</span>
</code></pre></div><h3 id='third-party-repos'>Third-party repos</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>Despite Ubuntu being based on Debian experimental, no Debian repository should ever
be directly mirrored and made available through aptly to a Ubuntu system <em>ever</em>.
There will be severe complications including failing or erroneous package upgrades,
broken dependencies and likely complete system failure.</p>
<p>The safest way to attempt to use a .deb package of another distro is to include its
source repository and compile the package yourself. After adding e.g. the Debian source
repository <code>deb-src http://deb.debian.org/debian/ experimental main contrib non-free</code>
and executing <code>apt-get update</code>, compilation of the desired software can be
attempted by invoking:</p>
<div class="highlight"><pre class="highlight plaintext"><code> apt-get build-dep &lt;package&gt; # For build dependencies
 apt-get source --compile &lt;package&gt; # To download source and compile package
</code></pre></div></blockquote>
<h4 id='initial-setup'>Initial setup</h4><p>After setting up a <code>aptly::mirror</code> resource in Puppet (do not use
<code>aptly mirror create</code>) you can sync and publish it to a prefix with:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly mirror update puppetlabs
$ sudo aptly snapshot create puppetlabs-$(date +%Y%m%d) from mirror puppetlabs
$ sudo -i aptly publish snapshot puppetlabs-$(date +%Y%m%d) puppetlabs
</code></pre></div><h4 id='updates'>Updates</h4><p>To pull new packages from an upstream repo, first sync:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly mirror update collectd
</code></pre></div><p>Assuming there are new packages then create a snapshot:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo aptly snapshot create collectd-$(date +%Y%m%d) from mirror collectd
</code></pre></div><p>Confirm that the package changes look as expected and that it doesn&rsquo;t
remove/replace a version that we are currently using:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo aptly snapshot diff collectd-20140101 collectd-20140102
  Arch   | Package                                  | Version in A                             | Version in B
! amd64  | collectd                                 | 5.3.0-ppa8~precise1                      | 5.4.0-ppa1~precise1
! amd64  | collectd-core                            | 5.3.0-ppa8~precise1                      | 5.4.0-ppa1~precise1
! amd64  | collectd-utils                           | 5.3.0-ppa8~precise1                      | 5.4.0-ppa1~precise1
! amd64  | libcollectdclient-dev                    | 5.3.0-ppa8~precise1                      | 5.4.0-ppa1~precise1
! amd64  | libcollectdclient1                       | 5.3.0-ppa8~precise1                      | 5.4.0-ppa1~precise1
</code></pre></div><p>Publish the new snapshot:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly publish switch precise collectd collectd-20140102
</code></pre></div><p>Finally, since we cache the mirror with Fastly, you&rsquo;ll need to purge the
content in the UI as described above under <a href="#local-repos">Local repos</a>.</p>
<p>For more about aptly and aptly commands please see their <a href="https://www.aptly.info/doc/overview/">documentation</a>.</p>
<h3 id='ppas'>PPAs</h3><p>We use Launchpad PPAs mostly for their good build pipeline; sand-boxed
builds in well maintained environments. Even if they can be slow.</p>
<p>However PPAs have a restriction that you can only have one active
version of a package in a PPA at any one time, which makes it difficult
to test and promote package changes through environments. We work around
this by using snapshots.</p>
<h4 id='initial-setup'>Initial setup</h4><p>Sync the repos created by Puppet&rsquo;s <code>aptly::mirror</code>. Mirrors are
distribution specific:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly mirror update govuk-ppa-precise
$ sudo -i aptly mirror update govuk-ppa-trusty
</code></pre></div><p>Create a snapshot of each distribution (just one currently):</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo aptly snapshot create govuk-ppa-precise-$(date +%Y%m%d) from mirror govuk-ppa-precise
$ sudo aptly snapshot create govuk-ppa-trusty-$(date +%Y%m%d) from mirror govuk-ppa-trusty
</code></pre></div><p>Publish each of them using environment-specific prefixes. Production and
Staging share the same prefix:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly publish snapshot govuk-ppa-precise-$(date +%Y%m%d) govuk/ppa/preview
$ sudo -i aptly publish snapshot govuk-ppa-trusty-$(date +%Y%m%d) govuk/ppa/preview
$ sudo -i aptly publish snapshot govuk-ppa-precise-$(date +%Y%m%d) govuk/ppa/production
$ sudo -i aptly publish snapshot govuk-ppa-trusty-$(date +%Y%m%d) govuk/ppa/production
</code></pre></div><h4 id='updates'>Updates</h4><p>When you have pushed a new package to the PPA and want to try it out on
Preview, sync and create a new snapshot:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly mirror update govuk-ppa-precise
$ sudo -i aptly mirror update govuk-ppa-trusty
$ sudo aptly snapshot create govuk-ppa-precise-$(date +%Y%m%d) from mirror govuk-ppa-precise
$ sudo aptly snapshot create govuk-ppa-trusty-$(date +%Y%m%d) from mirror govuk-ppa-trusty
</code></pre></div><p>Confirm that the changes look as expected:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo aptly snapshot diff govuk-ppa-precise-YYYYMMDD govuk-ppa-precise-$(date +%Y%m%d)
$ sudo aptly snapshot diff govuk-ppa-trusty-YYYYMMDD govuk-ppa-trusty-$(date +%Y%m%d)
</code></pre></div><p>Promote the snapshots to the Preview environment only:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo -i aptly publish switch precise govuk/ppa/preview govuk-ppa-precise-$(date +%Y%m%d)
$ sudo -i aptly publish switch trusty govuk/ppa/preview govuk-ppa-trusty-$(date +%Y%m%d)
</code></pre></div><p>If you&rsquo;re happy with the results on Preview then you can repeat the
publish step for Production (Staging uses the production mirror).</p>
<p>Finally, since we cache the mirror with Fastly, you&rsquo;ll need to purge the
content in the UI as described above under <a href="#local-repos">Local repos</a>.</p>
<h3 id='removing-mirrors-no-longer-in-use'>Removing mirrors no longer in use</h3><p>To remove a mirror that is no longer in use, run the following in order:</p>
<div class="highlight"><pre class="highlight plaintext"><code># Remove published repository
# Pay attention to the syntax, it's not &lt;repo&gt;/&lt;distribution&gt;
# as per the output of `aptly publish list`.
sudo aptly publish drop &lt;distribution&gt; &lt;repo&gt;

# Remove snapshots
sudo aptly snapshot list
sudo aptly snapshot drop &lt;repo&gt;-&lt;date&gt;

# Remove mirror
sudo aptly mirror drop &lt;repo&gt;
</code></pre></div>

  <div class='related-content'>

    <h3>More in the Packaging section</h3>

    <div class='govuk-grid-row'>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/publishing-a-ruby-gem.html">Publish a Ruby gem</a></li>
            <li><a href="/manual/publish-to-puppet-forge.html">Publish to Puppet Forge</a></li>
          </ul>
        </div>

    </div>
</div>


              <div data-module='page-expiry' data-last-reviewed-on="2020-09-02">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 2 March 2020.

        It needs to be reviewed again on 2 September 2020
        by the page owner <a href="">#re-govuk</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 2 September 2020
       by the page owner <a href="">#re-govuk</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/debian-packaging.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Manage%20Debian%20packages'&amp;body=Problem%20with%20'Manage%20Debian%20packages'%20(https://docs.publishing.service.gov.uk/manual/debian-packaging.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
