


<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Athena Fastly Logs Check - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/alerts/athena-fastly-logs-check.html">


      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Athena Fastly Logs Check" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/alerts/athena-fastly-logs-check.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta property="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Athena Fastly Logs Check - GOV.UK Developer Documentation" />
      <meta property="twitter:url" content="https://docs.publishing.service.gov.uk/manual/alerts/athena-fastly-logs-check.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apis.html">APIs</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Athena Fastly Logs Check</span></a>
    <ul>
      <li>
        <a href="#critical-alert"><span>Critical Alert</span></a>
        <ul>
          <li>
            <a href="#how-to-check-log-file-presence-and-validity"><span>How to check log file presence and validity</span></a>
          </li>
          <li>
            <a href="#how-to-check-the-quotgov-uk-fastly-logsquot-crawler"><span>How to check the “GOV.UK fastly logs” crawler</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#freshness-warning"><span>Freshness warning</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
                <div class="information-callout">
      This page describes what to do in case of an
      <a href='https://docs.publishing.service.gov.uk/manual/tools.html#icinga'>Icinga alert</a>.
      For more information you could
      <a href='https://github.com/alphagov/govuk-puppet/search?utf8=%E2%9C%93&q=athena-fastly-logs-check'>
        search the govuk-puppet repo for the source of the alert
      </a>
    </div>

   <h1 id='header'>Athena Fastly Logs Check</h1><p>The monitoring for <code>Athena has recent results for fastly_logs {database_name}</code>
is used to check that we can query a particular <a href="/manual/query-cdn-logs.html">Athena database containing
GOV.UK CDN log data</a>. It monitors this service by periodically
querying each of the monitored databases and checking that they have &gt; 0 results
over the preceding hours.</p>
<h2 id='critical-alert'>Critical Alert</h2><p>A critical alert indicates that the database either has no recent results or
that the process to query it failed. By looking at the Jenkins console output
you should be able to determine which of these situations occurred.</p>
<p>If the database query returned 0 results then this indicates that there
is a problem with data being available to query. To determine the cause of
this, you should check that:</p>

<ul>
<li><a href="#how-to-check-log-file-presence-and-validity">the Fastly CDN service is still sending logs to the expected S3 bucket and
these are in the expected JSON
structure</a>;</li>
<li><a href="#how-to-check-the-govuk-fastly-logs-crawler">the &ldquo;GOV.UK fastly logs&rdquo; crawler defined in AWS Glue doesn&rsquo;t have
errors in it&rsquo;s most recent logs</a>;</li>
<li>whether you can <a href="/manual/query-cdn-logs.html#example-queries">query the database yourself</a> manually via
Athena to confirm there is no recent data.</li>
</ul>
<p>There is also the possibility that there are no results because there hasn&rsquo;t
been any recent traffic to the particular environment. This is quite unlikely
in production, but may be experienced in integration or staging if the GOR
traffic replay isn&rsquo;t running.</p>
<p>If the query failed with an error rather than returning 0 results then it is
likely that we have data available but the monitoring is broken. In this case
you should inspect the failed Jenkins job for clues as to what is not working.
Potential causes could be: broken credentials, change in the AWS CLI tool
syntax, or a change in the Athena API.</p>
<h3 id='how-to-check-log-file-presence-and-validity'>How to check log file presence and validity</h3>
<ol>
<li><a href="https://docs.publishing.service.gov.uk/manual/set-up-aws-account.html#2-sign-in-to-aws">Sign into the AWS console</a> for the appropriate environment.</li>
<li>Browse to <a href="https://s3.console.aws.amazon.com/s3/home?region=eu-west-1#">S3</a> and find the <code>govuk-{environment}-fastly-logs</code> bucket.</li>
<li>Navigate through the directories of the database in question to verify a
directory exists for the current day, for example
<code>govuk_www/year=2020/month=02/date=20</code>.</li>
<li>If a directory exists for the current day check that there are files present
from the last few hours (the prefix search can make finding recent files
easier), new files should added approximately every 15 minutes and may
lag by 30 mins.</li>
<li>If a recent log file is found then you can verify the JSON is valid using
<a href="https://stedolan.github.io/jq/">jq</a>.

<ol>
<li>Download the file through S3 web interface.</li>
<li>Run the file through <code>jq</code> to check for errors and to view the JSON
structure, for example
<code>gunzip -c 2020-02-20T19_45_00.000-nINz8eDOPAd3Uv1Mq-jW.log.gz | jq</code>.</li>
<li>If there are errors parsing the JSON you should check the contents of
the file to identify the problem.</li>
</ol></li>
</ol>
<p>If you find that log files are not being written to S3 or the JSON is invalid
you should log into the <a href="https://manage.fastly.com">Fastly control panel</a>
(credentials are available in
<a href="https://github.com/alphagov/govuk-secrets">govuk-secrets</a>) and check the
logging configuration of the service in question. The expected JSON formatting
of CDN logs is defined in the <a href="https://github.com/alphagov/govuk-aws/blob/master/terraform/projects/infra-fastly-logs/main.tf">infra-fastly-logs</a> terraform
project and this should be checked to see if it was changed recently and/or
matches what is defined in the Fastly console.</p>
<h3 id='how-to-check-the-quotgov-uk-fastly-logsquot-crawler'>How to check the &ldquo;GOV.UK fastly logs&rdquo; crawler</h3>
<ol>
<li><a href="https://docs.publishing.service.gov.uk/manual/set-up-aws-account.html#2-sign-in-to-aws">Sign into the AWS console</a> for the appropriate environment.</li>
<li>Browse to <a href="https://eu-west-1.console.aws.amazon.com/glue/home?region=eu-west-1#catalog:tab=crawlers">AWS Glue</a> and navigate to the &ldquo;Crawlers&rdquo; section.</li>
<li>Find the crawler appropriate for the database, for example &ldquo;Assets fastly
logs&rdquo; is for the &ldquo;govuk_assets&rdquo; database.</li>
<li>View the logs from the last run by clicking the &ldquo;Logs&rdquo; link.</li>
<li>Check the crawler has run in a recent time period (it should run once every
4 hours).</li>
</ol>
<p>Any issues in the logs should help indicate where a problem may be. For example,
if you see entries indicating that many files don&rsquo;t match the expected schema
it may be that the database schema and JSON structure don&rsquo;t match. If you find
any discrepancies or that the crawler isn&rsquo;t running you should check that
the configuration is correct in the <a href="https://github.com/alphagov/govuk-aws/blob/master/terraform/projects/infra-fastly-logs/main.tf">infra-fastly-logs</a> terraform project
and that the configuration is applied.</p>
<h2 id='freshness-warning'>Freshness warning</h2><p>A freshness warning indicates that the Jenkins job to monitor the alerts has
not reported a success or failure in a sufficiently long time period.</p>
<p>Causes for this could be: the Jenkins job no longer exists; the job has been
misconfigured and isn&rsquo;t able to run on a schedule anymore; or the job is
running and there is a problem reporting it&rsquo;s completed status.</p>
<p>To resolve these issues you should investigate Jenkins for signs of problems
in the job and any downstream jobs it triggers.</p>


  <div class='related-content'>

</div>


              <div data-module='page-expiry' data-last-reviewed-on="2021-02-19">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 19 February 2020.

        It needs to be reviewed again on 19 February 2021
        by the page owner <a href="">#govuk-2ndline</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 19 February 2021
       by the page owner <a href="">#govuk-2ndline</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/alerts/athena-fastly-logs-check.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Athena%20Fastly%20Logs%20Check'&amp;body=Problem%20with%20'Athena%20Fastly%20Logs%20Check'%20(https://docs.publishing.service.gov.uk/manual/alerts/athena-fastly-logs-check.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
